<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core OS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-os: #050505;
            --bg-panel: rgba(20, 20, 23, 0.75);
            --bg-window: #09090b;
            --border: rgba(255, 255, 255, 0.08);
            --border-highlight: rgba(255, 255, 255, 0.15);
            --accent: #6366f1; /* Indigo */
            --accent-hover: #4f46e5;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            --font-ui: 'Inter', system-ui, sans-serif;
            --radius-win: 10px;
            --shadow-win: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            /* Default Glass Settings */
            --glass-blur: 20px;
            --glass-opacity: 0.6;
            --glass-saturation: 180%;
            --settings-surface: rgba(10, 10, 14, 0.85);
            --settings-border: rgba(255, 255, 255, 0.08);
            --settings-glow: 0 18px 30px rgba(0, 0, 0, 0.4);
        }

        /* --- NEW: SHUTDOWN SCREEN --- */
        #shutdown-screen {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
        }

            #shutdown-screen.active {
                opacity: 1;
                pointer-events: all;
            }


        /* --- NEW: SNAP GHOST (Aero Snap) --- */
        #snap-ghost {
            position: fixed;
            background: rgba(99, 102, 241, 0.2);
            border: 2px dashed var(--accent);
            border-radius: 12px;
            z-index: 5000;
            pointer-events: none;
            display: none;
            transition: all 0.1s ease;
            backdrop-filter: blur(5px);
        }

        /* --- NEW: NOTIFICATION CENTER --- */
        #notif-center {
            position: absolute;
            top: 40px;
            bottom: 10px;
            right: -320px; /* Hidden by default */
            width: 300px;
            background: rgba(18, 18, 20, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border);
            border-radius: 12px;
            z-index: 8000;
            transition: right 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }

            #notif-center.open {
                right: 10px;
            }

        .nc-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .nc-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nc-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            animation: slideInRight 0.3s ease;
            position: relative;
        }

        .nc-time {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .nc-msg {
            font-size: 12px;
            color: #e4e4e7;
            line-height: 1.4;
        }

        /* --- NEW: BROWSER TABS --- */
        .browser-tabs {
            display: flex;
            background: #18181b;
            padding: 8px 8px 0 8px;
            gap: 5px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }

        .b-tab {
            padding: 6px 12px;
            background: #27272a;
            border-radius: 8px 8px 0 0;
            font-size: 11px;
            color: #a1a1aa;
            min-width: 120px;
            max-width: 180px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid transparent;
            user-select: none;
        }

            .b-tab:hover {
                background: #3f3f46;
            }

            .b-tab.active {
                background: #fff;
                color: #000;
            }

        .b-tab-close {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

            .b-tab-close:hover {
                background: rgba(0,0,0,0.1);
                color: #ef4444;
            }

        /* --- GLOBAL RESET --- */
        * {
            box-sizing: border-box;
            user-select: none;
            scrollbar-width: thin;
            scrollbar-color: #333 transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #000;
            color: var(--text-main);
            font-family: var(--font-ui);
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #444;
            }

        /* --- UTILS --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .scale-up {
            animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleUp {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- BOOT & LOGIN --- */
        #boot-layer {
            position: absolute;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #bios-screen {
            position: absolute;
            inset: 0;
            background: rgba(4, 4, 8, 0.96);
            color: #f4f4f5;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bios-panel {
            width: 820px;
            background: rgba(12, 12, 18, 0.92);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 28px 70px rgba(0,0,0,0.7);
        }

        .bios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .bios-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .bios-item {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #login-screen {
            position: absolute;
            inset: 0;
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop') center/cover;
            z-index: 5000;
            backdrop-filter: blur(10px);
            transition: transform 0.35s ease, opacity 0.35s ease;
            will-change: transform;
        }

            #login-screen.swiping {
                transition: none;
            }

            #login-screen .login-swipe-hint {
                margin-top: 16px;
                font-size: 0.8rem;
                color: var(--text-muted);
                letter-spacing: 0.08em;
                text-transform: uppercase;
            }

            #login-screen .login-swipe-meter {
                margin: 14px auto 0;
                width: 140px;
                height: 4px;
                border-radius: 999px;
                background: rgba(255, 255, 255, 0.15);
                overflow: hidden;
                position: relative;
            }

                #login-screen .login-swipe-meter::after {
                    content: "";
                    position: absolute;
                    inset: 0;
                    transform: translateX(-100%);
                    background: linear-gradient(90deg, rgba(255, 77, 140, 0.9), rgba(0, 229, 255, 0.85));
                    transition: transform 0.2s ease;
                }

            #login-screen.swipe-armed .login-swipe-meter::after {
                transform: translateX(-10%);
            }

        .login-card {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--border);
            text-align: center;
            width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            /* The "Liquid Glass" Effect */
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation)) !important;
            background: rgba(20, 20, 25, var(--glass-opacity)) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.35s ease;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 2px solid white;
        }

        .login-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid transparent;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            width: 100%;
            margin-top: 15px;
            outline: none;
            transition: 0.2s;
            text-align: center;
        }

            .login-input:focus {
                border-color: var(--accent);
                background: rgba(255,255,255,0.15);
            }

        /* --- TOP BAR MENUS --- */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 25px;
            left: 0;
            background-color: #18181b;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
            border-radius: 6px;
            z-index: 3000;
        }

            .dropdown-content div {
                color: #e4e4e7;
                padding: 8px 12px;
                text-decoration: none;
                display: block;
                font-size: 13px;
                cursor: pointer;
            }

                .dropdown-content div:hover {
                    background-color: var(--accent);
                    color: white;
                }

            .dropdown-content .sep {
                height: 1px;
                background: #333;
                margin: 4px 0;
                padding: 0;
            }

        .show {
            display: block;
        }

        .status-item {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .status-menu {
            position: absolute;
            top: 32px;
            right: 0;
            width: 220px;
            background: rgba(15, 15, 18, 0.95);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            box-shadow: var(--shadow-win);
            display: none;
            z-index: 3200;
        }

            .status-menu.show {
                display: block;
            }

        .status-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .status-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
        }

        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .wifi-network {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
        }

            .wifi-network:hover {
                background: rgba(255, 255, 255, 0.08);
            }

        .wifi-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wifi-ssid {
            font-size: 0.85rem;
        }

        .wifi-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .status-footer {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }

            .status-footer button {
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text-main);
                padding: 4px 8px;
                border-radius: 6px;
                cursor: pointer;
            }

        /* --- FILE EXPLORER APP --- */
        .explorer-layout {
            display: flex;
            height: 100%;
            flex-direction: column;
        }

        .explorer-toolbar {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            background: #18181b;
        }

        .explorer-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: #a1a1aa;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

            .explorer-btn:hover {
                background: rgba(255,255,255,0.1);
                color: white;
            }

        .explorer-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .explorer-sidebar {
            width: 150px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid var(--border);
            padding: 10px;
        }

        .explorer-main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
        }

        .file-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
            border-radius: 6px;
        }

            .file-icon:hover {
                background: rgba(255,255,255,0.05);
            }

            .file-icon.selected {
                background: rgba(99, 102, 241, 0.3);
                border: 1px solid var(--accent);
            }

        .f-img {
            font-size: 32px;
            color: #fbbf24;
        }
        /* Folder Color */
        .f-name {
            font-size: 12px;
            text-align: center;
            word-break: break-all;
        }

        /* --- DESKTOP --- */
        #desktop {
            position: absolute;
            inset: 0;
            background: url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=2574&auto=format&fit=crop') center/cover;
            overflow: hidden;
        }

        /* Top Bar */
        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: rgba(9, 9, 11, 0.4);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 2000;
            /* The "Liquid Glass" Effect */
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation)) !important;
            background: rgba(20, 20, 25, var(--glass-opacity)) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .top-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }


        .top-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .menu-item:hover {
            color: white;
            cursor: pointer;
        }

        /* Dock */
        #dock-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }

        .dock {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(20, 20, 25, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 18px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: width 0.2s;
            /* The "Liquid Glass" Effect */
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation)) !important;
            background: rgba(20, 20, 25, var(--glass-opacity)) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: #27272a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #e4e4e7;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

            .app-icon:hover {
                transform: translateY(-8px) scale(1.1);
                margin: 0 5px;
                z-index: 10;
                box-shadow: 0 10px 15px rgba(0,0,0,0.5);
            }

            .app-icon.active::after {
                content: '';
                position: absolute;
                bottom: -6px;
                width: 5px;
                height: 5px;
                background: white;
                border-radius: 50%;
            }

        /* --- DEVTOYS STYLES --- */
        .devtoys-layout {
            display: flex;
            height: 100%;
        }

        .devtoys-sidebar {
            width: 140px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .tool-btn {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #a1a1aa;
            transition: 0.2s;
        }

            .tool-btn:hover {
                background: rgba(255,255,255,0.05);
                color: white;
            }

            .tool-btn.active {
                background: var(--accent);
                color: white;
            }

        .devtoys-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tool-view {
            display: none;
            height: 100%;
            flex-direction: column;
        }

            .tool-view.active {
                display: flex;
            }

        .dt-textarea {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--font-mono);
            padding: 10px;
            font-family: var(--font-mono);
            resize: none;
            outline: none;
            margin-bottom: 10px;
        }

        /* Icons Colors */
        .icon-term {
            background: linear-gradient(135deg, #1f2937, #111827);
            color: #10b981;
        }

        .icon-code {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            color: white;
        }

        .icon-git {
            background: linear-gradient(135deg, #f97316, #c2410c);
            color: white;
        }

        .icon-browser {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .icon-settings {
            background: linear-gradient(135deg, #4b5563, #374151);
            color: #e5e7eb;
        }

        /* --- WINDOW SYSTEM --- */
        .window {
            position: absolute;
            background: var(--bg-window);
            border: 1px solid var(--border);
            border-radius: var(--radius-win);
            box-shadow: var(--shadow-win);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
            animation: scaleUp 0.25s;
            resize: both;
            /* The "Liquid Glass" Effect */
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation)) !important;
            background: rgba(20, 20, 25, var(--glass-opacity)) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

            .window.maximized {
                top: 30px !important;
                left: 0 !important;
                width: 100% !important;
                height: calc(100% - 30px) !important;
                border-radius: 0;
                resize: none;
            }

        .title-bar {
            height: 38px;
            background: #121214;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 12px;
            justify-content: space-between;
            cursor: default;
        }

        .traffic-lights {
            display: flex;
            gap: 8px;
        }

        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.1s;
            position: relative;
        }

            .traffic-light:hover {
                filter: brightness(0.8);
            }

        .tf-close {
            background: #ff5f56;
        }

        .tf-min {
            background: #ffbd2e;
        }

        .tf-max {
            background: #27c93f;
        }

        .win-title {
            font-size: 13px;
            color: #a1a1aa;
            pointer-events: none;
            flex-grow: 1;
            text-align: center;
            font-weight: 500;
        }

        .window-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- APP SPECIFIC STYLES --- */

        /* --- UPDATED TERMINAL STYLES --- */
        #win-terminal .window-content {
            background: rgba(12, 12, 12, 0.85); /* Darker, slightly transparent */
            backdrop-filter: blur(20px); /* Acrylic blur */
        }

        .terminal-container {
            padding: 15px;
            font-family: 'Cascadia Code', 'Consolas', monospace; /* Authentic font */
            font-size: 14px;
            color: #cccccc;
            height: 100%;
            overflow-y: auto;
            cursor: text;
        }

        .term-input-line {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .term-prompt {
            color: #10b981; /* Default green prompt */
            margin-right: 8px;
            font-weight: 600;
            white-space: nowrap;
        }

        .term-input {
            background: transparent;
            border: none;
            color: inherit;
            flex: 1;
            outline: none;
            font-family: inherit;
            font-size: inherit;
            caret-color: white; /* Cursor color */
        }

        /* User Profile Settings styles */
        .profile-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        /* VS Code / Editor */
        .editor-layout {
            display: flex;
            height: 100%;
        }

        .editor-sidebar {
            width: 180px;
            background: #121214;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 10px;
            font-size: 11px;
            font-weight: bold;
            color: #71717a;
            letter-spacing: 0.5px;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .file-item {
            padding: 4px 10px;
            color: #a1a1aa;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 4px;
        }

            .file-item:hover {
                background: #27272a;
                color: white;
            }

            .file-item.active {
                background: #27272a;
                color: var(--accent);
            }

        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #09090b;
        }

        .editor-tabs {
            display: flex;
            background: #121214;
            overflow-x: auto;
            height: 36px;
        }

        .editor-tab {
            padding: 0 15px;
            border-right: 1px solid #1f1f22;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #71717a;
            cursor: pointer;
            min-width: 100px;
            justify-content: space-between;
        }

            .editor-tab.active {
                background: #09090b;
                color: #e4e4e7;
                border-top: 2px solid var(--accent);
            }

        .code-area {
            flex: 1;
            background: transparent;
            color: #e4e4e7;
            border: none;
            outline: none;
            padding: 15px;
            font-family: var(--font-mono);
            font-size: 14px;
            resize: none;
            white-space: pre;
            line-height: 1.5;
            tab-size: 2;
        }

        /* Git Client */
        .git-ui {
            padding: 20px;
            color: var(--text-main);
        }

        .git-stat {
            background: #18181b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .branch-badge {
            background: #27272a;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--accent);
        }

        /* Start Menu */
        #start-menu {
            /* Existing styles... */
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            width: 500px;
            height: 450px; /* Increased height slightly for better breathing room */
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            border-radius: 16px;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smoother animation */
            display: flex;
            flex-direction: column; /* Vital for the flex layout below */
            padding: 20px;
            z-index: 2001;
            overflow: hidden; /* Prevents rounded corners from being cut by scrollbar */
        }

            #start-menu.open {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
                pointer-events: all;
            }

        .search-bar {
            flex-shrink: 0;
            /* existing styles... */
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            width: 100%;
            outline: none;
            margin-bottom: 15px;
        }

        /* NEW: The scrollable wrapper */
        .start-menu-content {
            flex: 1; /* Takes up remaining space */
            overflow-y: auto; /* Enables vertical scrolling */
            padding-right: 5px; /* Spacing for scrollbar */
        }

            /* Custom Scrollbar for Start Menu */
            .start-menu-content::-webkit-scrollbar {
                width: 4px;
            }

            .start-menu-content::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
            }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
        }

            .grid-item:hover {
                background: rgba(255,255,255,0.05);
            }

        /* --- NEW APPS STYLES --- */

        /* AI Assistant */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #18181b;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

            .msg.user {
                align-self: flex-end;
                background: var(--accent);
                color: white;
                border-bottom-right-radius: 2px;
            }

            .msg.ai {
                align-self: flex-start;
                background: #27272a;
                color: #e4e4e7;
                border-bottom-left-radius: 2px;
                border: 1px solid var(--border);
            }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: #09090b;
            display: flex;
            gap: 10px;
        }

        /* Browser */
        .browser-bar {
            display: flex;
            gap: 10px;
            padding: 8px;
            background: #27272a;
            border-bottom: 1px solid var(--border);
        }

        .url-input {
            flex: 1;
            background: #09090b;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 5px 15px;
            color: white;
            font-size: 12px;
            outline: none;
        }

        .browser-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            transition: opacity 0.3s; /* Smooth fade in */
        }

        .browser-loading {
            height: 2px;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
        }

        .settings-shell {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .settings-section {
            background: var(--settings-surface);
            border: 1px solid var(--settings-border);
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: var(--settings-glow);
        }

        .settings-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .settings-section-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .settings-section-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .settings-card-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .settings-card {
            background: rgba(8, 8, 12, 0.7);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-card-title {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .settings-card-desc {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip-btn {
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-main);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            cursor: pointer;
        }

            .chip-btn.active {
                border-color: var(--accent);
                box-shadow: 0 0 0 1px var(--accent);
            }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

            .toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #27272a;
            border-radius: 999px;
            transition: 0.2s;
        }

            .toggle-slider::before {
                content: "";
                position: absolute;
                height: 18px;
                width: 18px;
                left: 3px;
                top: 3px;
                background: white;
                border-radius: 50%;
                transition: 0.2s;
            }

        .toggle input:checked + .toggle-slider {
            background: var(--accent);
        }

            .toggle input:checked + .toggle-slider::before {
                transform: translateX(20px);
            }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #a1a1aa;
            margin-bottom: 5px;
        }

        input[type=range] {
            width: 100%;
            accent-color: var(--accent);
        }

            .color-swatch {
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }

            .color-swatch:hover {
                transform: scale(1.05);
            }

        /* Toast Notification */
        #toast-area {
            position: absolute;
            top: 50px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9999;
        }

        .toast {
            background: #18181b;
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            gap: 10px;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Context Menu */
        #context-menu {
            position: absolute;
            background: #18181b;
            border: 1px solid var(--border);
            width: 180px;
            border-radius: 6px;
            padding: 5px;
            z-index: 9999;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .ctx-item {
            padding: 8px 12px;
            font-size: 13px;
            color: #e4e4e7;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }

            .ctx-item:hover {
                background: var(--accent);
                color: white;
            }

        .ctx-sep {
            height: 1px;
            background: #27272a;
            margin: 4px 0;
        }

        /* Syntax Highlight Simulation */
        .token-kw {
            color: #c792ea;
        }
        /* Keywords */
        .token-str {
            color: #c3e88d;
        }
        /* Strings */
        .token-fn {
            color: #82aaff;
        }
        /* Functions */

        /* --- APP: REQUEST (API Client) --- */
        .req-bar {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #18181b;
            border-bottom: 1px solid var(--border);
        }

        .req-method {
            background: #27272a;
            color: var(--accent);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 10px;
            font-weight: bold;
            outline: none;
        }

        .req-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .req-input-pane, .req-res-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .req-res-pane {
            border-left: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }

        /* --- APP: SQL STUDIO --- */
        .sql-layout {
            display: flex;
            height: 100%;
        }

        .sql-sidebar {
            width: 150px;
            background: #121214;
            border-right: 1px solid var(--border);
            padding: 10px;
        }

        .sql-table-item {
            padding: 8px;
            color: #a1a1aa;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .sql-table-item:hover {
                color: white;
                background: rgba(255,255,255,0.05);
                border-radius: 4px;
            }

        .sql-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #09090b;
        }

        .sql-query-area {
            height: 120px;
            background: #18181b;
            border-bottom: 1px solid var(--border);
            padding: 10px;
        }

        .sql-results {
            flex: 1;
            overflow: auto;
            padding: 0;
        }

        table.sql-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .sql-grid th, .sql-grid td {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid #27272a;
            color: #d4d4d8;
        }

        .sql-grid th {
            background: #1f1f22;
            color: #a1a1aa;
            position: sticky;
            top: 0;
        }

        /* --- APP: MARKTEXT (Markdown) --- */
        .md-editor {
            flex: 1;
            background: #121214;
            border: none;
            color: #e4e4e7;
            padding: 20px;
            font-family: var(--font-mono);
            resize: none;
            outline: none;
            line-height: 1.6;
        }

        .md-preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #09090b;
            border-left: 1px solid var(--border);
            color: #d4d4d8;
            font-family: var(--font-ui);
            line-height: 1.6;
        }

            .md-preview h1, .md-preview h2 {
                border-bottom: 1px solid #3f3f46;
                padding-bottom: 5px;
                color: white;
            }

            .md-preview code {
                background: #27272a;
                padding: 2px 5px;
                border-radius: 4px;
                font-family: var(--font-mono);
                color: var(--accent);
            }

            .md-preview blockquote {
                border-left: 3px solid var(--accent);
                margin: 0;
                padding-left: 15px;
                color: #a1a1aa;
            }

        /* --- FIX DROPDOWN COLORS --- */
        select.login-input {
            background-color: #18181b; /* Dark background */
            color: white; /* White text */
        }

            /* This targets the actual dropdown list popup */
            select.login-input option {
                background-color: #18181b;
                color: white;
            }

        /* --- SCREENSAVER (Matrix Rain) --- */
        #screensaver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 9999;
            display: none; /* Hidden by default */
            pointer-events: none; /* Let clicks pass through if needed, but usually we wake up */
        }

        /* --- THEME STORE --- */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 10px;
            overflow-y: auto;
        }

        .theme-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }

            .theme-card:hover {
                transform: translateY(-2px);
                border-color: var(--accent);
                background: rgba(255,255,255,0.1);
            }

        .theme-preview {
            height: 60px;
            border-radius: 4px;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }

        .theme-name {
            font-size: 13px;
            font-weight: bold;
            color: #f4f4f5;
        }

        /* --- ADD TO CSS --- */

        /* Desktop Shortcuts */
        #shortcut-area {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
        }

        .shortcut {
            position: absolute;
            width: 80px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 6px;
            cursor: pointer;
            pointer-events: auto; /* Re-enable clicks */
            color: white;
            text-align: center;
        }

            .shortcut:hover {
                background: rgba(255,255,255,0.1);
            }

            .shortcut:active {
                background: rgba(99, 102, 241, 0.3);
                border: 1px solid var(--accent);
            }

        .s-icon {
            font-size: 32px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .s-name {
            font-size: 11px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            word-break: break-word;
            line-height: 1.2;
        }

        /* Context Menu */
        #context-menu {
            position: absolute;
            display: none;
            background: #18181b;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 5px;
            min-width: 150px;
            z-index: 9999;
            box-shadow: 0 10px 15px rgba(0,0,0,0.5);
        }

        .ctx-item {
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            color: #e4e4e7;
            border-radius: 4px;
        }

            .ctx-item:hover {
                background: var(--accent);
                color: white;
            }

        /* Drag Ghost (Visual helper when dragging) */
        #drag-ghost {
            position: fixed;
            top: -100px;
            left: -100px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.8;
            background: #333;
            border: 1px solid white;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #trash-bin {
            transition: transform 0.2s, background 0.2s;
        }
            /* Visual feedback when dragging over trash */
            #trash-bin.drag-over {
                transform: scale(1.3);
                background: #ff0000 !important;
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            }

        .menu-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            height: 28px;
            white-space: nowrap;
        }

        .menu-icon {
            width: 18px;
            height: 18px;
            background: url('https://i.imgur.com/U1wZxl8.png') center/contain no-repeat;
            flex: 0 0 18px;
        }

        /* --- APP: FLASHEY (All on Admin) --- */
        #win-flashey {
            background: #09090b;
        }

        /* Flashey Avatar */
        .flashey-avatar-container {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .flashey-cloud {
            font-size: 80px;
            color: #cbd5e1; /* Cloud Gray */
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.4));
            animation: floaty 3s ease-in-out infinite;
            z-index: 2;
        }

        .flashey-bolt {
            position: absolute;
            font-size: 40px;
            color: #fbbf24; /* Lightning Yellow */
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            animation: flash 2s infinite;
        }

        .flashey-eyes {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            display: flex;
            justify-content: space-between;
            z-index: 4;
        }

        .eye {
            width: 8px;
            height: 8px;
            background: #1e293b;
            border-radius: 50%;
        }

        /* Modes Colors */
        .mode-hivise .flashey-cloud {
            color: #3f3f46;
            filter: drop-shadow(0 0 10px #ef4444);
        }

        .mode-hivise .flashey-bolt {
            color: #ef4444;
        }

        .mode-hivise .eye {
            background: #ef4444;
            box-shadow: 0 0 5px #ef4444;
        }

        .mode-helping .flashey-cloud {
            color: #e0f2fe;
            filter: drop-shadow(0 0 15px #38bdf8);
        }

        .mode-helping .flashey-bolt {
            color: #38bdf8;
        }

        .mode-helping .eye {
            background: #0ea5e9;
        }

        @keyframes floaty {
            0%, 100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes flash {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            90% {
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        /* Onboarding */
        .flashey-onboarding {
            position: absolute;
            inset: 0;
            background: #09090b;
            z-index: 10;
            padding: 30px;
            display: flex;
            flex-direction: column;
            text-align: center;
            align-items: center;
        }

        .flashey-btn {
            background: #27272a;
            border: 1px solid #3f3f46;
            padding: 10px 20px;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
            width: 100%;
        }

            .flashey-btn:hover {
                background: var(--accent);
                border-color: var(--accent);
            }

            .flashey-btn.danger:hover {
                background: #ef4444;
                border-color: #ef4444;
            }

        /* Code Helper Popup */
        #flashey-helper-popup {
            position: fixed;
            background: #18181b;
            border: 1px solid var(--accent);
            padding: 5px;
            border-radius: 6px;
            z-index: 9999;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--accent);
        }

        /* Troll Elements */
        .pigeon-overlay {
            position: fixed;
            width: 150px;
            pointer-events: none;
            z-index: 9998;
            animation: pigeonFly 5s linear forwards;
        }

        @keyframes pigeonFly {
            from {
                transform: translateX(-200px) translateY(0) rotate(10deg);
            }

            to {
                transform: translateX(110vw) translateY(-100px) rotate(-10deg);
            }
        }

        /* --- FLASHEY ADDON STORE --- */
        .flashey-store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 10px;
        }

        .addon-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }

            .addon-card:hover {
                border-color: var(--accent);
                transform: translateY(-2px);
            }

        .addon-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-muted);
        }

        .addon-title {
            font-size: 13px;
            font-weight: bold;
            color: var(--text-main);
            margin-bottom: 5px;
        }

        .addon-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.3;
            margin-bottom: 10px;
            height: 30px;
            overflow: hidden;
        }

        .install-btn {
            width: 100%;
            padding: 6px;
            font-size: 11px;
            background: #27272a;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

            .install-btn:hover {
                background: var(--accent);
            }

            .install-btn.installed {
                background: #10b981;
                pointer-events: none;
            }

        /* Download Bar Animation */
        .dl-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--accent);
            width: 0%;
            transition: width 0.2s;
        }

        /* --- FLASHEY WIDGET (Out of Window) --- */
        #flashey-widget {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 500; /* Above desktop icons, below active windows */
            display: none;
            align-items: center;
            justify-content: center;
            cursor: grab;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
            transition: transform 0.1s;
        }

            #flashey-widget:active {
                cursor: grabbing;
                transform: scale(0.95);
            }

        /* Widget Content styling */
        .widget-cloud {
            font-size: 60px;
            color: #cbd5e1;
            position: absolute;
        }

        .widget-eyes {
            position: absolute;
            top: 35px;
            width: 30px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        }

        .widget-eye {
            width: 6px;
            height: 6px;
            background: #1e293b;
            border-radius: 50%;
        }

        /* --- SKINS & MODES --- */
        /* Cute Mode Addon */
        .skin-cute .flashey-cloud, .skin-cute .widget-cloud {
            color: #fbcfe8 !important;
            filter: drop-shadow(0 0 15px #f472b6) !important;
        }

        .skin-cute .flashey-bolt {
            color: #f472b6 !important;
        }

        .skin-cute .eye, .skin-cute .widget-eye {
            background: #be185d !important;
        }

        .skin-cute .flashey-eyes::after { /* Blush */
            content: '';
            position: absolute;
            top: 8px;
            width: 100%;
            height: 5px;
            background: rgba(255,100,100,0.3);
            border-radius: 50%;
            blur: 2px;
        }

        /* Focus Mode Overlay */
        #focus-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 90; /* Below active window (100) but above others */
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* --- APP: NEXUS (Finder/Search) --- */
        #win-nexus {
            background: transparent !important; /* Transparent window container */
            box-shadow: none !important;
            border: none !important;
            backdrop-filter: none !important;
        }

        .nexus-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }

        .nexus-bar {
            width: 600px;
            background: rgba(20, 20, 25, 0.8);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            animation: nexusFloat 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

            .nexus-bar:hover {
                transform: scale(1.02);
                border-color: var(--accent);
            }

        .nexus-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 24px;
            color: white;
            outline: none;
            font-weight: 300;
        }

        .nexus-results {
            width: 600px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nexus-item {
            background: rgba(30, 30, 35, 0.9);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            animation: slideUp 0.3s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

            .nexus-item:nth-child(1) {
                animation-delay: 0.05s;
            }

            .nexus-item:nth-child(2) {
                animation-delay: 0.1s;
            }

            .nexus-item:nth-child(3) {
                animation-delay: 0.15s;
            }

            .nexus-item:nth-child(4) {
                animation-delay: 0.2s;
            }

            .nexus-item:hover {
                background: var(--accent);
                color: white;
            }

        @keyframes nexusFloat {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- APP: PRISM GALLERY (Photos) --- */
        .prism-layout {
            display: flex;
            height: 100%;
        }

        .prism-sidebar {
            width: 200px;
            background: rgba(0,0,0,0.2);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .prism-nav-btn {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            color: #a1a1aa;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }

            .prism-nav-btn:hover, .prism-nav-btn.active {
                background: rgba(255,255,255,0.1);
                color: white;
            }

            .prism-nav-btn.active {
                background: var(--accent);
            }

        .prism-main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        /* Gallery Grid */
        .prism-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .prism-img-card {
            aspect-ratio: 1;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
        }

            .prism-img-card:hover {
                transform: scale(1.05);
                border-color: var(--accent);
                z-index: 2;
            }

            .prism-img-card img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        /* Camera Mode */
        .prism-camera-view {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .camera-frame {
            width: 90%;
            max-width: 640px;
            aspect-ratio: 16/9;
            background: #111;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        video#camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
        }

        .shutter-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255,255,255,0.3);
            margin-top: 20px;
            cursor: pointer;
            transition: 0.2s;
        }

            .shutter-btn:active {
                transform: scale(0.9);
                background: var(--accent);
            }

        /* --- APP: SENTINEL (Security Center) --- */
        :root {
            --sentinel-bg: #0f172a;
            --sentinel-sidebar: #1e293b;
            --sentinel-accent: #38bdf8; /* Sky Blue */
            --sentinel-danger: #f43f5e;
            --sentinel-success: #10b981;
        }

        #win-sentinel {
            background: var(--sentinel-bg);
            border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.1);
        }

        .sentinel-layout {
            display: flex;
            height: 100%;
            color: #e2e8f0;
        }

        .sentinel-sidebar {
            width: 200px;
            background: var(--sentinel-sidebar);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        .sentinel-nav-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            color: #94a3b8;
        }

            .sentinel-nav-item:hover {
                background: rgba(255,255,255,0.05);
                color: white;
            }

            .sentinel-nav-item.active {
                background: linear-gradient(90deg, rgba(56, 189, 248, 0.2), transparent);
                color: var(--sentinel-accent);
                border-left: 3px solid var(--sentinel-accent);
            }

        .sentinel-main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }

        /* Dashboard View */
        .sentinel-status-ring {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--sentinel-sidebar);
            border-top-color: var(--sentinel-accent);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--sentinel-accent);
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.2);
            animation: sentinelPulse 3s infinite;
            position: relative;
        }

            .sentinel-status-ring::after {
                content: '';
                position: absolute;
                inset: -10px;
                border-radius: 50%;
                border: 1px dashed rgba(56, 189, 248, 0.3);
                animation: spin 10s linear infinite;
            }

        @keyframes sentinelPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(56, 189, 248, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(56, 189, 248, 0);
            }
        }

        .sentinel-stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .sentinel-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Scanner View */
        .scan-progress-container {
            height: 6px;
            background: #1e293b;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .scan-bar {
            height: 100%;
            width: 0%;
            background: var(--sentinel-accent);
            box-shadow: 0 0 10px var(--sentinel-accent);
            transition: width 0.2s linear;
        }

        .scan-file-text {
            font-family: var(--font-mono);
            font-size: 11px;
            color: #64748b;
            height: 20px;
            overflow: hidden;
        }

        .threat-item {
            background: rgba(244, 63, 94, 0.1);
            border: 1px solid rgba(244, 63, 94, 0.3);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            animation: slideInRight 0.3s ease;
        }

        /* VPN View */
        .vpn-map {
            height: 200px;
            background: #0f172a;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .vpn-dot {
            width: 8px;
            height: 8px;
            background: #64748b;
            border-radius: 50%;
            position: absolute;
            transition: 0.3s;
        }

            .vpn-dot.active {
                background: var(--sentinel-success);
                box-shadow: 0 0 10px var(--sentinel-success);
                transform: scale(1.5);
            }

        .vpn-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, var(--sentinel-success), transparent);
            transform-origin: left;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .sentinel-big-btn {
            background: var(--sentinel-accent);
            color: #000;
            font-weight: bold;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            transition: 0.2s;
        }

            .sentinel-big-btn:hover {
                filter: brightness(1.1);
                box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
            }

            .sentinel-big-btn.connected {
                background: var(--sentinel-success);
                color: white;
            }

    </style>
</head>
<body>
    <canvas id="screensaver"></canvas>

    <audio id="snd-boot" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio> <div id="shutdown-screen">
        <div class="spinner" style="border-top-color: #ef4444;"></div>
        <h3 style="margin-top:20px; font-weight: 300;">SHUTTING DOWN</h3>
    </div>

    <div id="snap-ghost"></div>

    <div id="flashey-widget" onmousedown="windowManager.startDrag(event, 'flashey-widget')">
        <i class="fa-solid fa-cloud widget-cloud"></i>
        <div class="widget-eyes">
            <div class="widget-eye"></div>
            <div class="widget-eye"></div>
        </div>
        <div style="position:absolute; top:-30px; background:#27272a; padding:5px 10px; border-radius:20px; font-size:10px; color:white; display:none;" id="widget-speech">
            Hi!
        </div>
    </div>

    <div id="focus-overlay"></div>

    <div id="notif-center">
        <div class="nc-header">
            <span>Notifications</span>
            <button onclick="notificationCenter.clear()" style="background:transparent; border:none; color:var(--text-muted); cursor:pointer; font-size:11px;">Clear All</button>
        </div>
        <div class="nc-body" id="nc-list">
            <div style="text-align:center; color:var(--text-muted); font-size:12px; margin-top:20px;">No new notifications</div>
        </div>
    </div>

    <div id="boot-layer">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px; font-weight: 300; letter-spacing: 2px;">CORE<span style="font-weight:700">OS</span></h3>
        <p style="color: #52525b; font-size: 12px;">
            Initializing Kernel v4.2.0...
            F6 for BIOS
        </p>
    </div>

    <div id="bios-screen" class="hidden">
        <div class="bios-panel">
            <div class="bios-header">
                <div>
                    <div style="font-weight:600; font-size:1.1rem;">CoreBoard BIOS</div>
                    <div style="color:#a1a1aa; font-size:0.85rem;">Press Continue to resume boot</div>
                </div>
                <button class="login-input" style="width:auto; padding:6px 14px;" onclick="exitBios()">Continue</button>
            </div>
            <div class="bios-grid">
                <div class="bios-item"><span>Model</span><strong>CoreBoard X1</strong></div>
                <div class="bios-item"><span>Firmware</span><strong>CBX1-4.2.0</strong></div>
                <div class="bios-item"><span>Secure Boot</span><strong>Enabled</strong></div>
                <div class="bios-item"><span>Virtualization</span><strong>Active</strong></div>
                <div class="bios-item"><span>Memory</span><strong>32 GB</strong></div>
                <div class="bios-item"><span>Storage</span><strong>1 TB NVMe</strong></div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="hidden flex-center flex-col">
        <div class="login-card">
            <div class="avatar"><i class="fa-solid fa-user-astronaut"></i></div>
            <h2 style="margin: 0;">Senior Dev</h2>
            <p style="color: #a1a1aa; font-size: 0.9rem;">Core OS Security</p>
            <input type="password" id="password-input" class="login-input" placeholder="Enter Password (any)" onkeypress="checkLogin(event)">
            <div id="login-swipe-ui" class="hidden">
                <div class="login-swipe-hint">Swipe up to unlock</div>
                <div class="login-swipe-meter"></div>
            </div>
        </div>
    </div>

    <div id="drag-ghost">
        <div id="ghost-icon" style="font-size: 24px; margin-bottom:5px;"></div>
        <div id="ghost-name" style="font-size: 12px;"></div>
    </div>

    <div id="context-menu"></div>

    <div id="shortcut-area"></div>

    <div id="desktop" class="hidden" oncontextmenu="handleRightClick(event)" onclick="hideContextMenu(event)">

        <div id="top-bar">
            <div class="top-left">
                <span class="menu-item menu-icon"></span>
                <span class="menu-item" style="font-weight:700;">Core OS</span>

                <div class="dropdown">
                    <span class="menu-item" onclick="toggleMenu('menu-file')">File</span>
                    <div id="menu-file" class="dropdown-content">
                        <div onclick="appManager.open('code')">New File</div>
                        <div onclick="fileSystem.saveSystem()">Save System State</div>
                        <div class="sep"></div>
                        <div onclick="window.close()">Shut Down</div>
                    </div>
                </div>

                <div class="dropdown">
                    <span class="menu-item" onclick="toggleMenu('menu-edit')">Edit</span>
                    <div id="menu-edit" class="dropdown-content">
                        <div onclick="notifications.show('Undo not implemented', 'warning')">Undo</div>
                        <div class="sep"></div>
                        <div onclick="notifications.show('Copied', 'success')">Copy</div>
                        <div onclick="notifications.show('Pasted', 'success')">Paste</div>
                    </div>
                </div>

                <div class="dropdown">
                    <span class="menu-item" onclick="toggleMenu('menu-view')">View</span>
                    <div id="menu-view" class="dropdown-content">
                        <div onclick="document.documentElement.requestFullscreen()">Enter Fullscreen</div>
                        <div onclick="document.exitFullscreen()">Exit Fullscreen</div>
                        <div class="sep"></div>
                        <div onclick="location.reload()">Refresh UI</div>
                    </div>
                </div>

                <div class="dropdown">
                    <span class="menu-item" onclick="toggleMenu('menu-tools')">Tools</span>
                    <div id="menu-tools" class="dropdown-content">
                        <div onclick="appManager.open('terminal')">Terminal</div>
                        <div onclick="appManager.open('settings')">Settings</div>
                    </div>
                </div>
            </div>

            <div class="top-right">
                <div class="status-item" id="wifi-status">
                    <span class="menu-item" onclick="toggleWifiMenu(event)"><i class="fa-solid fa-wifi"></i></span>
                    <div id="wifi-menu" class="status-menu">
                        <div class="status-title">Wi-Fi</div>
                        <div id="wifi-list" class="status-list"></div>
                        <div class="status-footer">
                            <button type="button" onclick="wifiManager.refresh()">Refresh</button>
                        </div>
                    </div>
                </div>
                <span class="menu-item" onclick="notificationCenter.toggle()">
                    <i class="fa-regular fa-bell"></i>
                </span>
                <div class="status-item" id="battery-status">
                    <span class="menu-item" onclick="toggleBatteryMenu(event)"><i class="fa-solid fa-battery-full"></i></span>
                    <div id="battery-menu" class="status-menu">
                        <div class="status-title">Battery</div>
                        <div class="status-row">Charge <strong>100%</strong></div>
                    </div>
                </div>
                <span class="menu-item" id="clock">12:00</span>
            </div>
        </div>

        <div id="start-menu">
            <input type="text" class="search-bar" id="start-search" placeholder="Search apps, files, or commands..." oninput="renderStartMenuApps()">

            <div class="start-menu-content">
                <div style="font-size: 12px; color: #71717a; margin-bottom: 10px; margin-top: 5px;">PINNED APPS</div>
                <div class="app-grid" id="pinned-apps"></div>

                <div style="font-size: 12px; color: #71717a; margin: 20px 0 10px;">ALL APPS</div>
                <div class="app-grid" id="all-apps"></div>
            </div>
        </div>

        <div id="dock-container">
            <div class="dock">
                <div class="app-icon"
                     onclick="toggleStartMenu()"
                     style="
                        background: #111 url('https://i.imgur.com/U1wZxl8.png') center/contain no-repeat;
                      ">
                </div>
                <div style="width:1px; background:rgba(255,255,255,0.1); margin:0 5px;"></div>
                <div class="app-icon icon-term" onclick="appManager.open('terminal')" oncontextmenu="showAppContextMenu(event, 'terminal')" id="dock-terminal"><i class="fa-solid fa-terminal"></i></div>
                <div class="app-icon icon-code" onclick="appManager.open('code')" oncontextmenu="showAppContextMenu(event, 'code')" id="dock-code"><i class="fa-solid fa-code"></i></div>
                <div class="app-icon icon-git" onclick="appManager.open('git')" oncontextmenu="showAppContextMenu(event, 'git')" id="dock-git"><i class="fa-brands fa-git-alt"></i></div>
                <div class="app-icon" style="background: linear-gradient(135deg, #fbbf24, #d97706); color:white;" onclick="appManager.open('explorer')" oncontextmenu="showAppContextMenu(event, 'explorer')" id="dock-explorer">
                    <i class="fa-solid fa-folder-open"></i>
                </div>
                <div class="app-icon" style="background: linear-gradient(135deg, #fbbf24, #d97706); color:white;" onclick="appManager.open('flashey')" oncontextmenu="showAppContextMenu(event, 'flashey')" id="dock-flashey"><i class="fa-solid fa-bolt"></i></div>
                <div class="app-icon icon-browser" onclick="appManager.open('browser')" oncontextmenu="showAppContextMenu(event, 'browser')" id="dock-browser"><i class="fa-brands fa-chrome"></i></div>
                <div class="app-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706); color:white;" onclick="appManager.open('devtoys')" oncontextmenu="showAppContextMenu(event, 'devtoys')" id="dock-devtoys"><i class="fa-solid fa-toolbox"></i></div>
                <div class="app-icon" style="background: linear-gradient(135deg, #FF6B6B, #EE5253); color:white;" onclick="appManager.open('request')" oncontextmenu="showAppContextMenu(event, 'request')" id="dock-request"><i class="fa-solid fa-satellite-dish"></i></div>
                <div class="app-icon" style="background: linear-gradient(135deg, #48dbfb, #0abde3); color:white;" onclick="appManager.open('sql')" oncontextmenu="showAppContextMenu(event, 'sql')" id="dock-sql"><i class="fa-solid fa-database"></i></div>
                <div class="app-icon"
                     style="background: linear-gradient(135deg, #ec4899, #be185d); color:white;"
                     onclick="appManager.open('nexus')"
                     oncontextmenu="showAppContextMenu(event, 'nexus')"
                     id="dock-nexus">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <div class="app-icon"
                     style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color:white;"
                     onclick="appManager.open('photos')"
                     oncontextmenu="showAppContextMenu(event, 'photos')"
                     id="dock-photos">
                    <i class="fa-solid fa-images"></i>
                </div>
                <div class="app-icon" style="background: linear-gradient(135deg, #a8a29e, #78716c); color:white;" onclick="appManager.open('themes')" oncontextmenu="showAppContextMenu(event, 'themes')" id="dock-themes"><i class="fa-solid fa-palette"></i></div>
                <div class="app-icon icon-settings" onclick="appManager.open('settings')" oncontextmenu="showAppContextMenu(event, 'settings')" id="dock-settings"><i class="fa-solid fa-gear"></i></div>
                <div id="trash-bin" class="app-icon" style="background: linear-gradient(135deg, #ef4444, #991b1b); margin-left: 20px;">
                    <i class="fa-solid fa-trash-can"></i>
                </div>
            </div>
        </div>

        <div id="win-terminal" class="window hidden" style="left: 100px; top: 80px; width: 600px; height: 400px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-terminal')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('terminal')"></div>
                    <div class="traffic-light tf-min" onclick="appManager.minimize('terminal')"></div>
                    <div class="traffic-light tf-max" onclick="appManager.maximize('terminal')"></div>
                </div>
                <div class="win-title">user@core-os: ~</div>
            </div>
            <div class="window-content">
                <div class="terminal-container" id="term-body" onclick="document.getElementById('term-input').focus()">
                    <div class="term-output">Core OS Kernel v4.2.0 initialized.</div>
                    <div class="term-output" style="margin-bottom: 10px; color: #a1a1aa;">Type 'help' for commands.</div>
                    <div class="term-input-line">
                        <span class="term-prompt">user@core:~$</span>
                        <input type="text" id="term-input" class="term-input" autocomplete="off" spellcheck="false">
                    </div>
                </div>
            </div>
        </div>

        <div id="win-code" class="window hidden" style="left: 150px; top: 100px; width: 800px; height: 500px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-code')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-max" onclick="appManager.maximize('code')"></div>
                    <div class="traffic-light tf-min" onclick="appManager.minimize('code')"></div>
                    <div class="traffic-light tf-close" onclick="appManager.close('code')"></div>
                </div>
                <div class="win-title">DevStudio</div>
            </div>
            <div class="window-content">
                <div class="editor-layout">
                    <div class="editor-sidebar">
                        <div class="sidebar-header">EXPLORER</div>
                        <div class="file-list" id="editor-file-list">
                        </div>
                    </div>
                    <div class="editor-main">
                        <div class="editor-tabs" id="editor-tabs">
                        </div>
                        <textarea id="code-area" class="code-area" oninput="fileSystem.saveCurrentFile()"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-git" class="window hidden" style="left: 400px; top: 200px; width: 500px; height: 350px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-git')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('git')"></div>
                    <div class="traffic-light tf-min" onclick="appManager.minimize('git')"></div>
                </div>
                <div class="win-title">GitLens</div>
            </div>
            <div class="window-content" style="background: #121214;">
                <div class="git-ui">
                    <h3>Source Control</h3>
                    <div class="git-stat">
                        <span><i class="fa-solid fa-code-branch"></i> Current Branch</span>
                        <span class="branch-badge">main</span>
                    </div>
                    <div style="font-size: 12px; color: #a1a1aa; margin-bottom: 10px;">CHANGES</div>
                    <div id="git-changes">
                        <div style="padding: 10px; border: 1px dashed #333; text-align: center; border-radius: 6px;">No changes detected</div>
                    </div>
                    <button style="width: 100%; margin-top: 20px; padding: 8px; background: var(--accent); border: none; color: white; border-radius: 4px; cursor: pointer;" onclick="notifications.show('Committed to main', 'success')">Commit & Push</button>
                </div>
            </div>
        </div>

        <div id="win-nexus" class="window hidden" style="left: 50%; top: 100px; transform: translateX(-50%); width: 700px; height: 500px;">
            <div class="window-content nexus-container">
                <div class="nexus-bar">
                    <i class="fa-solid fa-magnifying-glass" style="font-size: 24px; color: var(--accent);"></i>
                    <input type="text" id="nexus-input" class="nexus-input" placeholder="Search Apps, Files, or Web..." oninput="nexusApp.search(this.value)" onkeydown="nexusApp.handleKey(event)" autofocus>
                </div>

                <div id="nexus-results" class="nexus-results">
                </div>

                <div style="margin-top: auto; padding: 10px; color: #52525b; font-size: 12px;">
                    Press ESC to close  Enter to open
                </div>
            </div>
        </div>

        <div id="win-photos" class="window hidden" style="left: 150px; top: 80px; width: 900px; height: 600px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-photos')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('photos')"></div>
                    <div class="traffic-light tf-max" onclick="appManager.maximize('photos')"></div>
                </div>
                <div class="win-title">Prism Gallery</div>
            </div>
            <div class="window-content prism-layout">
                <div class="prism-sidebar">
                    <div class="prism-nav-btn active" id="btn-library" onclick="prismApp.switchTab('library')">
                        <i class="fa-regular fa-images"></i> Library
                    </div>
                    <div class="prism-nav-btn" id="btn-camera" onclick="prismApp.switchTab('camera')">
                        <i class="fa-solid fa-camera"></i> Camera
                    </div>
                    <div style="margin-top: auto; font-size: 11px; color: #52525b; padding: 10px;">
                        <i class="fa-solid fa-hard-drive"></i> Connected to System Pictures
                    </div>
                </div>

                <div class="prism-main">
                    <div id="prism-view-library">
                        <h2 style="margin-top:0; font-weight:300;">My <span style="font-weight:700; color:var(--accent)">Photos</span></h2>
                        <div id="prism-grid" class="prism-grid">
                            <div style="grid-column: 1/-1; text-align:center; padding:50px; color:#52525b;">
                                <i class="fa-solid fa-spinner fa-spin"></i> Loading system images...
                            </div>
                        </div>
                    </div>

                    <div id="prism-view-camera" class="hidden prism-camera-view">
                        <div class="camera-frame">
                            <video id="camera-feed" autoplay playsinline></video>
                            <canvas id="camera-canvas" class="hidden"></canvas>
                        </div>
                        <button class="shutter-btn" onclick="prismApp.takePhoto()"></button>
                        <div style="margin-top:10px; color:#71717a; font-size:12px;">Saved to Pictures/CoreOS_Captures</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-explorer" class="window hidden" style="left: 100px; top: 100px; width: 700px; height: 500px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-explorer')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('explorer')"></div>
                    <div class="traffic-light tf-max" onclick="appManager.maximize('explorer')"></div>
                </div>
                <div class="win-title">File Explorer</div>
            </div>
            <div class="window-content explorer-layout">
                <div class="explorer-toolbar">
                    <div style="padding:8px; background:rgba(0,0,0,0.3); display:flex; gap:10px; border-bottom:1px solid var(--border);">
                        <button onclick="explorerApp.goUp()" style="background:transparent; border:1px solid var(--border); color:white; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-arrow-up"></i></button>
                        <button onclick="explorerApp.newFolder()" style="background:transparent; border:1px solid var(--border); color:white; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-folder-plus"></i></button>
                        <button onclick="explorerApp.newFile()" style="background:transparent; border:1px solid var(--border); color:white; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-file-circle-plus"></i></button>
                        <input id="exp-path" type="text" style="flex:1; background:rgba(0,0,0,0.5); border:none; color:white; padding:4px 8px; border-radius:4px; font-size:12px;" readonly>
                    </div>
                </div>
                <div class="explorer-body">
                    <div class="explorer-sidebar">
                        <div class="file-item" onclick="explorerApp.navigate('__ROOT__')">
                            <i class="fa-solid fa-hard-drive"></i> System Disk
                        </div>

                        <div class="file-item" onclick="explorerApp.navigate(explorerApp.special.home)">
                            <i class="fa-solid fa-house"></i> Home
                        </div>

                        <div class="file-item" onclick="explorerApp.navigate(explorerApp.special.documents)">
                            <i class="fa-solid fa-folder"></i> Documents
                        </div>

                        <div class="file-item" onclick="explorerApp.navigate(explorerApp.special.downloads)">
                            <i class="fa-solid fa-download"></i> Downloads
                        </div>
                    </div>
                    <div class="explorer-main">
                        <div class="file-grid" id="file-grid">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-flashey" class="window hidden" style="left: 300px; top: 150px; width: 380px; height: 550px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-flashey')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('flashey')"></div>
                    <div class="traffic-light tf-min" onclick="appManager.minimize('flashey')"></div>
                </div>
                <div class="win-title">All on Admin</div>
                <div style="width:50px; text-align:right;"><i class="fa-solid fa-gear" style="cursor:pointer; color:#71717a;" onclick="flasheyApp.toggleSettings()"></i></div>
            </div>

            <div class="window-content" style="position:relative; overflow:hidden;">

                <div id="flashey-onboarding" class="flashey-onboarding">
                    <div style="font-size: 60px; color: var(--accent); margin-bottom: 20px;"><i class="fa-solid fa-bolt"></i></div>
                    <h2 style="margin:0;">Welcome to All on Admin</h2>
                    <p style="color:#a1a1aa; font-size:13px; line-height:1.5; margin: 20px 0;">
                        I am <strong id="intro-name">Flashey</strong>. I run in the background to enhance your OS experience.
                    </p>

                    <div style="text-align:left; background:#18181b; padding:15px; border-radius:8px; border:1px solid #333; margin-bottom:20px;">
                        <div style="margin-bottom:10px; font-size:13px;">
                            <strong style="color:#38bdf8;">Helping Core Mode:</strong><br>
                            <span style="color:#71717a; font-size:12px;">Auto-code completion, syntax fixes, system optimization.</span>
                        </div>
                        <div style="font-size:13px;">
                            <strong style="color:#ef4444;">Hivise Mode:</strong><br>
                            <span style="color:#71717a; font-size:12px;">Chaotic behavior, random windows, visual trolling. Use at own risk.</span>
                        </div>
                    </div>

                    <div style="margin-top:auto; width:100%;">
                        <div style="font-size:10px; color:#52525b; margin-bottom:10px;">By clicking Accept, you agree to let this app modify system behavior.</div>
                        <button class="flashey-btn" onclick="flasheyApp.completeOnboarding()">Accept Terms & Start</button>
                    </div>
                </div>

                <div id="flashey-dashboard" style="padding:20px; display:flex; flex-direction:column; height:100%; display:none;">

                    <div id="flashey-avatar" class="flashey-avatar-container">
                        <i class="fa-solid fa-cloud flashey-cloud"></i>
                        <div class="flashey-eyes">
                            <div class="eye"></div><div class="eye"></div>
                        </div>
                        <i class="fa-solid fa-bolt flashey-bolt"></i>
                    </div>

                    <h3 id="flashey-display-name" style="text-align:center; margin:0;">Flashey</h3>
                    <p id="flashey-status" style="text-align:center; color:#a1a1aa; font-size:12px; margin-top:5px;">Waiting for command...</p>

                    <div style="margin-top:30px; display:flex; flex-direction:column; gap:15px;">
                        <div class="settings-card" onclick="flasheyApp.setMode('helping')" style="cursor:pointer; border-color: transparent;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="color:#38bdf8; font-weight:bold;"><i class="fa-solid fa-wand-magic-sparkles"></i> Helping Core</span>
                                <div id="ind-helping" style="width:10px; height:10px; border-radius:50%; background:#333;"></div>
                            </div>
                        </div>

                        <div class="settings-card" onclick="flasheyApp.setMode('hivise')" style="cursor:pointer; border-color: transparent;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="color:#ef4444; font-weight:bold;"><i class="fa-solid fa-mask"></i> Hivise Mode</span>
                                <div id="ind-hivise" style="width:10px; height:10px; border-radius:50%; background:#333;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="flashey-settings" style="position:absolute; inset:0; background:#09090b; z-index:5; padding:20px; transform:translateX(100%); transition:0.3s; display:flex; flex-direction:column;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                        <i class="fa-solid fa-arrow-left" style="cursor:pointer;" onclick="flasheyApp.toggleSettings()"></i>
                        <h3 style="margin:0;">Config</h3>
                    </div>

                    <div class="settings-card" style="margin-bottom:15px;">
                        <div class="settings-card-title">Assistant Name</div>
                        <input type="text" id="flashey-rename" class="login-input" placeholder="Flashey" oninput="flasheyApp.rename(this.value)">
                    </div>

                    <div class="settings-card" onclick="flasheyStore.open()" style="cursor:pointer; margin-bottom:15px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="background:#27272a; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#6366f1;">
                                <i class="fa-solid fa-puzzle-piece"></i>
                            </div>
                            <div>
                                <div class="settings-card-title">Download Addons</div>
                                <div class="settings-card-desc">Get skins, modes & plugins</div>
                            </div>
                            <i class="fa-solid fa-chevron-right" style="margin-left:auto; color:#52525b;"></i>
                        </div>
                    </div>

                    <div class="settings-card" id="hivise-config-card" style="display:none;">
                        <div class="settings-card-title">Hivise Intensity</div>
                        <input type="range" min="1" max="10" value="5" onchange="flasheyApp.config.intensity = this.value">
                    </div>

                    <button class="flashey-btn danger" style="margin-top:auto;" onclick="flasheyApp.reset()">Factory Reset App</button>
                </div>

            </div>
        </div>

        <div id="flashey-helper-popup">Suggestion...</div>

        <div id="win-flashey-store" class="window hidden" style="left: 350px; top: 200px; width: 500px; height: 400px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-flashey-store')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('flashey-store')"></div>
                </div>
                <div class="win-title">Flashey Addons</div>
            </div>
            <div class="window-content" style="display:flex; flex-direction:column; background:#09090b;">
                <div style="padding:15px; border-bottom:1px solid #27272a;">
                    <input type="text" class="login-input" placeholder="Search addons..." onkeyup="flasheyStore.filter(this.value)">
                </div>
                <div id="flashey-store-list" class="flashey-store-grid" style="overflow-y:auto; flex:1;">
                </div>
            </div>
        </div>

        <div id="win-browser" class="window hidden" style="left: 200px; top: 100px; width: 900px; height: 600px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-browser')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('browser')"></div>
                    <div class="traffic-light tf-max" onclick="appManager.maximize('browser')"></div>
                </div>
                <div class="win-title">Core Navigator</div>
            </div>
            <div class="window-content" style="display:flex; flex-direction:column; background:#fff;">
                <div class="browser-bar" style="background:#27272a; border-bottom:1px solid #333; padding:8px; display:flex; gap:8px; align-items:center;">
                    <i class="fa-solid fa-arrow-left" style="color:#a1a1aa; cursor:pointer; padding:5px;" onclick="browserApp.back()"></i>
                    <i class="fa-solid fa-arrow-right" style="color:#a1a1aa; cursor:pointer; padding:5px;" onclick="browserApp.forward()"></i>
                    <i class="fa-solid fa-rotate-right" style="color:#a1a1aa; cursor:pointer; padding:5px;" onclick="browserApp.reload()"></i>

                    <input type="text" id="browser-url" class="url-input"
                           style="flex:1; background:#18181b; border:1px solid #3f3f46; color:white; padding:6px 15px; border-radius:15px; outline:none; font-size:13px;"
                           value="https://www.google.com"
                           onkeypress="browserApp.handleInput(event)">
                </div>

                <div style="height:2px; width:100%; background:#27272a;">
                    <div id="browser-loader" style="height:100%; width:0%; background:var(--accent); transition: width 0.2s;"></div>
                </div>

                <webview id="browser-view"
                         src="https://www.google.com"
                         style="flex:1; width:100%; height:100%;"
                         autosize="on"
                         allowpopups
                         useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36">
                </webview>
            </div>
        </div>

        <div id="win-settings" class="window hidden" style="left: 350px; top: 200px; width: 500px; height: 500px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-settings')">
                <div class="traffic-lights"><div class="traffic-light tf-close" onclick="appManager.close('settings')"></div></div>
                <div class="win-title">System Settings</div>
            </div>
            <div class="window-content" style="padding:20px; overflow-y:auto;">
                <div class="settings-shell">
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div>
                                <div class="settings-section-title">Personalization</div>
                                <div class="settings-section-subtitle">Shape the look and feel of Core OS.</div>
                            </div>
                        </div>
                        <div class="settings-card-grid">
                            <div class="settings-card">
                                <div class="settings-card-title">Accent Color</div>
                                <div class="settings-grid" style="padding:0;">
                                    <div class="color-swatch" style="background:#6366f1" onclick="systemConfig.setAccent('#6366f1')"></div>
                                    <div class="color-swatch" style="background:#10b981" onclick="systemConfig.setAccent('#10b981')"></div>
                                    <div class="color-swatch" style="background:#ef4444" onclick="systemConfig.setAccent('#ef4444')"></div>
                                    <div class="color-swatch" style="background:#f59e0b" onclick="systemConfig.setAccent('#f59e0b')"></div>
                                    <div class="color-swatch" style="background:#ec4899" onclick="systemConfig.setAccent('#ec4899')"></div>
                                    <div class="color-swatch" style="background:#06b6d4" onclick="systemConfig.setAccent('#06b6d4')"></div>
                                </div>
                                <div class="settings-card-desc">Accent color powers highlights, toggles, and selection rings.</div>
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Surface Style</div>
                                <div class="chip-row">
                                    <button class="chip-btn" id="style-glass" onclick="systemConfig.setVisualStyle('glass')">Liquid Flow</button>
                                    <button class="chip-btn" id="style-prism" onclick="systemConfig.setVisualStyle('prism')">Prism Veil</button>
                                </div>
                                <div class="settings-card-desc">Liquid Flow keeps the classic vibe. Prism Veil is a Coreoriginal, iridescent texture.</div>
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Liquid Flow Controls</div>
                                <div class="slider-container">
                                    <div class="slider-label"><span>Transparency</span><span id="val-opacity">60%</span></div>
                                    <input type="range" min="10" max="100" value="60" oninput="systemConfig.setGlass('opacity', this.value)">
                                </div>
                                <div class="slider-container">
                                    <div class="slider-label"><span>Blur Radius</span><span id="val-blur">20px</span></div>
                                    <input type="range" min="0" max="50" value="20" oninput="systemConfig.setGlass('blur', this.value)">
                                </div>
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Wallpaper</div>
                                <div class="chip-row">
                                    <button class="chip-btn" onclick="systemConfig.setWallpaper(0)">Cyber</button>
                                    <button class="chip-btn" onclick="systemConfig.setWallpaper(1)">Space</button>
                                    <button class="chip-btn" onclick="systemConfig.setWallpaper(2)">Neon</button>
                                    <button class="chip-btn" onclick="systemConfig.setWallpaper(3)">Abstract</button>
                                </div>
                                <div class="settings-card-desc">Choose the vibe for your home screen.</div>
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Clock</div>
                                <div class="toggle-row">
                                    <span class="settings-card-desc">Show seconds</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="toggle-seconds" onchange="systemConfig.setShowSeconds(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div>
                                <div class="settings-section-title">Security & Privacy</div>
                                <div class="settings-section-subtitle">Builtin protection for browsing sessions.</div>
                            </div>
                        </div>
                        <div class="settings-card-grid">
                            <div class="settings-card">
                                <div class="settings-card-title">Ad Blocker</div>
                                <div class="toggle-row">
                                    <span class="settings-card-desc">Block ads on websites + autoskip YouTube ads.</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="toggle-adblock" onchange="systemConfig.setAdBlocker(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-card-desc">Runs in the Core Navigator webview, including the YouTube skip routine.</div>
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Focus Filter</div>
                                <div class="toggle-row">
                                    <span class="settings-card-desc">Mute notification sounds during deep work.</span>
                                    <label class="toggle">
                                        <input type="checkbox" onchange="notifications.show('Focus Filter toggled', 'success')">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Lock Screen</div>
                                <div class="toggle-row" style="margin-bottom:10px;">
                                    <span class="settings-card-desc">Require password on unlock.</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="toggle-password-required" onchange="systemConfig.setPasswordEnabled(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-grid" style="grid-template-columns: 1fr auto; align-items:center; gap:10px; margin-bottom:10px;">
                                    <input type="password" id="password-setting" class="login-input" placeholder="Set a new password">
                                    <button class="login-input" style="width:auto; padding:8px 14px;" onclick="systemConfig.updatePassword()">Save</button>
                                </div>
                                <div class="toggle-row">
                                    <span class="settings-card-desc">Swipe up to unlock.</span>
                                    <label class="toggle">
                                        <input type="checkbox" id="toggle-swipe-unlock" onchange="systemConfig.setSwipeToUnlock(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-card-desc" id="password-status">Password can be disabled for free access.</div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div>
                                <div class="settings-section-title">Sound & Media</div>
                                <div class="settings-section-subtitle">Audio routing and volume control.</div>
                            </div>
                        </div>
                        <div class="settings-card-grid">
                            <div class="settings-card">
                                <div class="settings-card-title">Output Device</div>
                                <select id="audio-output-select" class="login-input" style="text-align:left;" onchange="audioManager.setDevice(this.value)">
                                    <option>Default Output</option>
                                </select>
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Master Volume</div>
                                <div class="slider-container">
                                    <div class="slider-label"><span>Volume</span><span id="val-vol">100%</span></div>
                                    <input type="range" min="0" max="100" value="100" oninput="audioManager.setVolume(this.value); document.getElementById('val-vol').innerText = this.value + '%'">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div>
                                <div class="settings-section-title">User Profile</div>
                                <div class="settings-section-subtitle">Manage your identity.</div>
                            </div>
                        </div>
                        <div class="profile-preview">
                            <div class="avatar" style="width:60px; height:60px; font-size:1.5rem; margin:0;">
                                <i class="fa-solid fa-user-astronaut"></i>
                            </div>
                            <div style="text-align:center;">
                                <div id="preview-username" style="font-weight:bold; font-size:1.1rem;">Senior Dev</div>
                                <div id="preview-title" style="color:var(--text-muted); font-size:0.9rem;">Core OS Security</div>
                            </div>
                        </div>
                        <div class="settings-card-grid">
                            <div class="settings-card">
                                <div class="settings-card-title">Username</div>
                                <input type="text" id="set-username" class="login-input" placeholder="Senior Dev" style="text-align:left; margin-top:5px;" oninput="systemConfig.updateProfilePreview()">
                            </div>
                            <div class="settings-card">
                                <div class="settings-card-title">Job Title</div>
                                <input type="text" id="set-title" class="login-input" placeholder="Core OS Security" style="text-align:left; margin-top:5px;" oninput="systemConfig.updateProfilePreview()">
                            </div>
                        </div>
                        <button class="login-input" style="width:auto; margin-top:10px; background:var(--accent); border:none;" onclick="systemConfig.saveProfile()">Save Profile</button>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div>
                                <div class="settings-section-title">Typography</div>
                                <div class="settings-section-subtitle">Choose your coding typeface.</div>
                            </div>
                        </div>
                        <div class="settings-card">
                            <select class="login-input" onchange="systemConfig.setFont(this.value)" style="text-align:left;">
                                <option value="'JetBrains Mono', monospace">JetBrains Mono (Default)</option>
                                <option value="'Fira Code', monospace">Fira Code</option>
                                <option value="'Courier New', monospace">Courier New (Retro)</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div>
                                <div class="settings-section-title">System</div>
                                <div class="settings-section-subtitle">Reset configuration to defaults.</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="login-input" style="width:auto; padding:8px 15px; margin-top:10px; background:var(--danger); border:none;" onclick="systemConfig.reset()">Factory Reset</button>
                            <button class="login-input" style="width:auto; padding:8px 15px; margin-top:10px;" onclick="systemConfig.rebootInstaller()">Reboot to Installer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-sentinel" class="window hidden" style="left: 150px; top: 100px; width: 800px; height: 550px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-sentinel')">
                <div class="traffic-lights">
                    <div class="traffic-light tf-close" onclick="appManager.close('sentinel')"></div>
                    <div class="traffic-light tf-min" onclick="appManager.minimize('sentinel')"></div>
                </div>
                <div class="win-title">Sentinel</div>
            </div>
            <div class="window-content sentinel-layout">
                <div class="sentinel-sidebar">
                    <div style="font-size:11px; font-weight:bold; color:#64748b; margin:10px 0 10px 15px;">PROTECTION</div>
                    <div class="sentinel-nav-item active" onclick="sentinelApp.switchTab('dash', this)">
                        <i class="fa-solid fa-shield-halved"></i> Dashboard
                    </div>
                    <div class="sentinel-nav-item" onclick="sentinelApp.switchTab('scan', this)">
                        <i class="fa-solid fa-crosshairs"></i> Virus Scan
                    </div>
                    <div style="font-size:11px; font-weight:bold; color:#64748b; margin:20px 0 10px 15px;">NETWORK</div>
                    <div class="sentinel-nav-item" onclick="sentinelApp.switchTab('vpn', this)">
                        <i class="fa-solid fa-earth-americas"></i> VPN
                    </div>
                    <div class="sentinel-nav-item" onclick="sentinelApp.switchTab('net', this)">
                        <i class="fa-solid fa-wifi"></i> WiFi Audit
                    </div>
                </div>

                <div class="sentinel-main">

                    <div id="sen-view-dash">
                        <div class="sentinel-status-ring" id="sen-status-icon">
                            <i class="fa-solid fa-check"></i>
                        </div>
                        <div style="text-align:center;">
                            <h2 style="margin:0;">System Secure</h2>
                            <p style="color:#94a3b8; font-size:13px;">Real-time protection is active.</p>
                        </div>

                        <div class="sentinel-stat-grid">
                            <div class="sentinel-card">
                                <div style="font-size:12px; color:#94a3b8;">THREATS BLOCKED</div>
                                <div style="font-size:24px; font-weight:bold;">0</div>
                            </div>
                            <div class="sentinel-card">
                                <div style="font-size:12px; color:#94a3b8;">LAST SCAN</div>
                                <div style="font-size:16px;">Just now</div>
                            </div>
                            <div class="sentinel-card">
                                <div style="font-size:12px; color:#94a3b8;">FIREWALL</div>
                                <div style="color:var(--sentinel-success);"><i class="fa-solid fa-lock"></i> Active</div>
                            </div>
                        </div>

                        <h3 style="margin-top:30px;">Quick Actions</h3>
                        <div class="toggle-row" style="background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; margin-bottom:10px;">
                            <div>
                                <div style="font-weight:600;">Browser Shield</div>
                                <div style="font-size:12px; color:#94a3b8;">Blocks ads and trackers in Core Navigator.</div>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" checked onchange="systemConfig.setAdBlocker(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div id="sen-view-scan" class="hidden">
                        <h2>System Scan</h2>
                        <div style="background:#1e293b; padding:20px; border-radius:12px; text-align:center;">
                            <div id="scan-animation" style="font-size:40px; color:var(--sentinel-accent); margin-bottom:10px;">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </div>
                            <div id="scan-status">Ready to scan</div>

                            <div class="scan-progress-container">
                                <div class="scan-bar" id="scan-bar"></div>
                            </div>
                            <div class="scan-file-text" id="scan-file">Waiting...</div>

                            <button class="sentinel-big-btn" id="btn-start-scan" style="margin-top:20px;" onclick="sentinelApp.startScan()">Quick Scan</button>
                        </div>

                        <h3 style="margin-top:20px;">Threat History</h3>
                        <div id="threat-list">
                            <div style="color:#64748b; font-size:13px; font-style:italic;">No threats detected recently.</div>
                        </div>
                    </div>

                    <div id="sen-view-vpn" class="hidden">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h2 style="margin:0;">Sentinel VPN</h2>
                            <div style="background:#1e293b; padding:5px 10px; border-radius:6px; font-size:12px; color:var(--sentinel-success);">
                                <i class="fa-solid fa-shield-cat"></i> Encrypted
                            </div>
                        </div>

                        <div class="vpn-map" id="vpn-map-container">
                            <div style="position:absolute; inset:0; opacity:0.1; background:url('https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg') center/cover no-repeat;"></div>
                        </div>

                        <div style="display:flex; gap:20px;">
                            <div style="flex:1;">
                                <label style="font-size:12px; color:#94a3b8;">LOCATION</label>
                                <select id="vpn-loc-select" class="login-input" style="text-align:left; margin-top:5px;">
                                    <option value="us"> New York, USA</option>
                                    <option value="uk"> London, UK</option>
                                    <option value="jp"> Tokyo, Japan</option>
                                    <option value="de"> Berlin, Germany</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:12px; color:#94a3b8;">STATUS</label>
                                <div id="vpn-status-text" style="margin-top:10px; font-weight:bold; color:#94a3b8;">Disconnected</div>
                            </div>
                        </div>

                        <button class="sentinel-big-btn" id="btn-vpn-toggle" style="margin-top:20px;" onclick="sentinelApp.toggleVPN()">Connect</button>
                    </div>

                    <div id="sen-view-net" class="hidden">
                        <h2>Wi-Fi Audit</h2>
                        <div class="sentinel-card" style="align-items:center; padding:40px;">
                            <div style="font-size:4rem; color:var(--sentinel-accent); margin-bottom:10px;" id="net-icon">
                                <i class="fa-solid fa-wifi"></i>
                            </div>
                            <div id="net-status-msg" style="font-size:1.2rem; font-weight:bold;">Audit Ready</div>
                            <div id="net-details" style="color:#94a3b8; font-size:13px;">Click test to analyze current connection.</div>

                            <button class="login-input" style="width:auto; margin-top:20px; background:var(--sentinel-accent); border:none;" onclick="sentinelApp.testNetwork()">Run Security Test</button>
                        </div>

                        <div class="sentinel-stat-grid" id="net-results" style="opacity:0.5;">
                            <div class="sentinel-card" style="align-items:center;">
                                <div style="font-size:12px;">PING</div>
                                <div style="font-size:18px; font-weight:bold;">-- ms</div>
                            </div>
                            <div class="sentinel-card" style="align-items:center;">
                                <div style="font-size:12px;">DOWNLOAD</div>
                                <div style="font-size:18px; font-weight:bold;">-- Mbps</div>
                            </div>
                            <div class="sentinel-card" style="align-items:center;">
                                <div style="font-size:12px;">ENCRYPTION</div>
                                <div style="font-size:18px; font-weight:bold;">--</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="win-devtoys" class="window hidden" style="left: 250px; top: 150px; width: 700px; height: 500px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-devtoys')">
                <div class="traffic-lights"><div class="traffic-light tf-close" onclick="appManager.close('devtoys')"></div></div>
                <div class="win-title">DevToys</div>
            </div>
            <div class="window-content">
                <div class="devtoys-layout">
                    <div class="devtoys-sidebar">
                        <div class="tool-btn active" onclick="devToys.switchTab('json')">JSON Format</div>
                        <div class="tool-btn" onclick="devToys.switchTab('base64')">Base64</div>
                        <div class="tool-btn" onclick="devToys.switchTab('lorem')">Lorem Ipsum</div>
                    </div>
                    <div class="devtoys-main">
                        <div id="tool-json" class="tool-view active">
                            <h3 style="margin-top:0">JSON Formatter</h3>
                            <textarea id="dt-json-input" class="dt-textarea" placeholder="Paste messy JSON here..."></textarea>
                            <div style="margin-bottom:10px; display:flex; gap:10px;">
                                <button class="login-input" style="width:auto; margin:0;" onclick="devToys.formatJSON()">Format</button>
                                <button class="login-input" style="width:auto; margin:0;" onclick="devToys.minifyJSON()">Minify</button>
                            </div>
                            <textarea id="dt-json-output" class="dt-textarea" readonly placeholder="Pretty JSON will appear here..."></textarea>
                        </div>
                        <div id="tool-base64" class="tool-view">
                            <h3 style="margin-top:0">Base64 Encoder/Decoder</h3>
                            <textarea id="dt-b64-input" class="dt-textarea" placeholder="Type text to encode/decode..."></textarea>
                            <div style="margin-bottom:10px; display:flex; gap:10px;">
                                <button class="login-input" style="width:auto; margin:0;" onclick="devToys.b64Encode()">Encode</button>
                                <button class="login-input" style="width:auto; margin:0;" onclick="devToys.b64Decode()">Decode</button>
                            </div>
                            <textarea id="dt-b64-output" class="dt-textarea" readonly></textarea>
                        </div>
                        <div id="tool-lorem" class="tool-view">
                            <h3 style="margin-top:0">Lorem Ipsum Generator</h3>
                            <div style="margin-bottom:15px;">
                                <button class="login-input" style="width:auto; margin:0;" onclick="devToys.genLorem(1)">1 Para</button>
                                <button class="login-input" style="width:auto; margin:0;" onclick="devToys.genLorem(3)">3 Paras</button>
                                <button class="login-input" style="width:auto; margin:0;" onclick="devToys.genLorem(5)">5 Paras</button>
                            </div>
                            <textarea id="dt-lorem-output" class="dt-textarea" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-request" class="window hidden" style="left: 120px; top: 120px; width: 700px; height: 500px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-request')">
                <div class="traffic-lights"><div class="traffic-light tf-close" onclick="appManager.close('request')"></div></div>
                <div class="win-title">Postman Clone</div>
            </div>
            <div class="window-content" style="display:flex; flex-direction:column;">
                <div class="req-bar">
                    <select id="req-method" class="req-method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                    </select>
                    <input id="req-url" type="text" class="login-input" style="margin:0; text-align:left;" value="https://jsonplaceholder.typicode.com/posts/1">
                    <button onclick="requestApp.send()" class="login-input" style="width:auto; margin:0; background:var(--accent); border:none;">Send</button>
                </div>
                <div class="req-body">
                    <div class="req-input-pane">
                        <div style="font-size:12px; color:#a1a1aa; margin-bottom:5px;">REQUEST BODY (JSON)</div>
                        <textarea id="req-json-body" class="dt-textarea" style="background:#121214;">{ "title": "foo", "body": "bar", "userId": 1 }</textarea>
                    </div>
                    <div class="req-res-pane">
                        <div style="font-size:12px; color:#a1a1aa; margin-bottom:5px; display:flex; justify-content:space-between;">
                            <span>RESPONSE</span>
                            <span id="req-status" style="color:var(--success);"></span>
                        </div>
                        <textarea id="req-response" class="dt-textarea" style="background:transparent; border:none;" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-sql" class="window hidden" style="left: 180px; top: 150px; width: 800px; height: 550px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-sql')">
                <div class="traffic-lights"><div class="traffic-light tf-close" onclick="appManager.close('sql')"></div></div>
                <div class="win-title">SQL Studio</div>
            </div>
            <div class="window-content">
                <div class="sql-layout">
                    <div class="sql-sidebar">
                        <div style="font-size:11px; font-weight:bold; color:#52525b; margin-bottom:10px;">TABLES</div>
                        <div class="sql-table-item" onclick="sqlApp.insertTemplate('users')"><i class="fa-solid fa-table"></i> users</div>
                        <div class="sql-table-item" onclick="sqlApp.insertTemplate('logs')"><i class="fa-solid fa-table"></i> sys_logs</div>
                        <div class="sql-table-item" onclick="sqlApp.insertTemplate('products')"><i class="fa-solid fa-table"></i> products</div>
                    </div>
                    <div class="sql-main">
                        <div class="sql-query-area">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span style="font-size:12px; color:#a1a1aa;">QUERY EDITOR</span>
                                <button onclick="sqlApp.run()" style="background:var(--success); border:none; color:white; border-radius:4px; padding:2px 10px; cursor:pointer; font-size:11px;"><i class="fa-solid fa-play"></i> Run</button>
                            </div>
                            <textarea id="sql-input" class="code-area" style="padding:0;">SELECT * FROM users</textarea>
                        </div>
                        <div class="sql-results" id="sql-output">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-markdown" class="window hidden" style="left: 250px; top: 100px; width: 900px; height: 600px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-markdown')">
                <div class="traffic-lights"><div class="traffic-light tf-close" onclick="appManager.close('markdown')"></div></div>
                <div class="win-title">MarkText</div>
            </div>
            <div class="window-content" style="display:flex; height:100%;">
                <textarea id="md-input" class="md-editor" oninput="mdApp.render()"># Welcome to MarkText

**Core OS** includes a built-in markdown editor.

- [x] Fast
- [ ] Bloated

> "Code is poetry."

## Try typing here!
        </textarea>
                <div id="md-output" class="md-preview"></div>
            </div>
        </div>

        <div id="win-themes" class="window hidden" style="left: 300px; top: 150px; width: 500px; height: 400px;">
            <div class="title-bar" onmousedown="windowManager.startDrag(event, 'win-themes')">
                <div class="traffic-lights"><div class="traffic-light tf-close" onclick="appManager.close('themes')"></div></div>
                <div class="win-title">Appearance</div>
            </div>
            <div class="window-content" style="padding: 20px;">
                <h3 style="margin-top:0; color:white;">Select Theme</h3>
                <p style="color:var(--text-muted); font-size:13px; margin-bottom:15px;">Personalize your environment.</p>

                <div class="theme-grid">
                    <div class="theme-card" onclick="themeManager.setTheme('default')">
                        <div class="theme-preview" style="background:linear-gradient(45deg, #6366f1, #050505);"></div>
                        <div class="theme-name">Core Default</div>
                    </div>
                    <div class="theme-card" onclick="themeManager.setTheme('matrix')">
                        <div class="theme-preview" style="background:linear-gradient(45deg, #00ff41, #000);"></div>
                        <div class="theme-name">The Construct</div>
                    </div>
                    <div class="theme-card" onclick="themeManager.setTheme('synth')">
                        <div class="theme-preview" style="background:linear-gradient(45deg, #ff00ff, #2b003b);"></div>
                        <div class="theme-name">Neon Night</div>
                    </div>
                    <div class="theme-card" onclick="themeManager.setTheme('nord')">
                        <div class="theme-preview" style="background:linear-gradient(45deg, #88c0d0, #2e3440);"></div>
                        <div class="theme-name">Arctic Ice</div>
                    </div>
                    <div class="theme-card" onclick="themeManager.setTheme('spiderpunk')">
                        <div class="theme-preview" style="background:linear-gradient(45deg, #ff3d8b, #00d1ff);"></div>
                        <div class="theme-name">Spiderpunk</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="toast-area"></div>

        <div id="context-menu">
            <div class="ctx-item" onclick="appManager.open('terminal')">Open Terminal Here</div>
            <div class="ctx-item" onclick="appManager.open('code')">Open with Code</div>
            <div class="ctx-sep"></div>
            <div class="ctx-item" onclick="fileSystem.createFileUI()">New File...</div>
            <div class="ctx-item" onclick="location.reload()">Refresh System</div>
        </div>

    </div>

    <script>

        const { ipcRenderer } = require("electron")
        const pathModule = require("path");

        async function checkAuth() {
            const loggedIn = await ipcRenderer.invoke("get-auth-state")
            if (loggedIn) unlockDesktop()
            setupCrossDisplayListeners();
        }

        checkAuth()

        /* --- APP: SENTINEL LOGIC --- */
        const sentinelApp = {
            vpnConnected: false,
            scanInProgress: false,

            init: () => {
                // Generate VPN Map Dots
                const map = document.getElementById('vpn-map-container');
                const locs = [
                    { top: '35%', left: '25%' }, // US
                    { top: '30%', left: '48%' }, // UK
                    { top: '35%', left: '85%' }, // JP
                    { top: '32%', left: '52%' }  // DE
                ];

                locs.forEach((pos, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'vpn-dot';
                    dot.style.top = pos.top;
                    dot.style.left = pos.left;
                    dot.id = `vpn-dot-${index}`;
                    map.appendChild(dot);
                });

                // Add to Registry so it can be opened
                appRegistry['sentinel'] = { name: "Sentinel", icon: "fa-shield-halved", color: "#38bdf8" };

                // Add to Dock (Optional auto-add, or let user add via context menu)
                if (!dockApps.includes('sentinel')) {
                    dockApps.push('sentinel');
                    saveDockApps();
                    renderDock(); // Ensure renderDock exists in your main code
                }
            },

            switchTab: (tabId, btn) => {
                // Update Sidebar
                document.querySelectorAll('.sentinel-nav-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');

                // Update View
                ['dash', 'scan', 'vpn', 'net'].forEach(id => {
                    document.getElementById(`sen-view-${id}`).classList.add('hidden');
                });
                document.getElementById(`sen-view-${tabId}`).classList.remove('hidden');
            },

            startScan: () => {
                if (sentinelApp.scanInProgress) return;
                sentinelApp.scanInProgress = true;

                const btn = document.getElementById('btn-start-scan');
                const status = document.getElementById('scan-status');
                const fileTxt = document.getElementById('scan-file');
                const bar = document.getElementById('scan-bar');
                const icon = document.getElementById('scan-animation');
                const list = document.getElementById('threat-list');

                btn.disabled = true;
                btn.innerText = "Scanning...";
                status.innerText = "Heuristic Analysis in progress...";
                icon.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                list.innerHTML = ''; // Clear previous

                let progress = 0;
                const fakeFiles = [
                    "/System32/drivers/etc", "/User/Downloads/suspicious.exe", "/Boot/Config",
                    "/Kernel/Memory/0x84F", "Checking Registry keys...", "Analyzing Heuristics..."
                ];

                const interval = setInterval(() => {
                    progress += Math.random() * 5;
                    if (progress > 100) progress = 100;

                    bar.style.width = progress + "%";
                    fileTxt.innerText = fakeFiles[Math.floor(Math.random() * fakeFiles.length)];

                    // Random "Threat" found logic
                    if (progress > 40 && progress < 50 && document.querySelectorAll('.threat-item').length === 0) {
                        const threat = document.createElement('div');
                        threat.className = 'threat-item';
                        threat.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:#f43f5e;"><i class="fa-solid fa-satellite-dish"></i> Nothing found.</div>
                    </div>
                    <button style="background:#f43f5e; border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="this.parentElement.remove()">Clear</button>
                 `;
                        list.appendChild(threat);
                    }

                    if (progress === 100) {
                        clearInterval(interval);
                        sentinelApp.scanInProgress = false;
                        btn.disabled = false;
                        btn.innerText = "Quick Scan";
                        status.innerText = "Scan Complete.";
                        icon.innerHTML = '<i class="fa-solid fa-check" style="color:#10b981"></i>';
                        fileTxt.innerText = "Analysis finished.";
                        notifications.show("Sentinel Scan Finished", "success");
                    }
                }, 150);
            },

            toggleVPN: () => {
                const btn = document.getElementById('btn-vpn-toggle');
                const status = document.getElementById('vpn-status-text');
                const dots = document.querySelectorAll('.vpn-dot');
                const select = document.getElementById('vpn-loc-select');

                // Map selection index
                let mapIndex = 0;
                if (select.value === 'uk') mapIndex = 1;
                if (select.value === 'jp') mapIndex = 2;
                if (select.value === 'de') mapIndex = 3;

                sentinelApp.vpnConnected = !sentinelApp.vpnConnected;

                if (sentinelApp.vpnConnected) {
                    btn.innerText = "Connecting...";

                    setTimeout(() => {
                        btn.innerText = "Disconnect";
                        btn.classList.add('connected');
                        status.innerText = "Connected to " + select.options[select.selectedIndex].text;
                        status.style.color = "#10b981";

                        // Animate Map
                        dots.forEach(d => d.classList.remove('active'));
                        const activeDot = document.getElementById(`vpn-dot-${mapIndex}`);
                        if (activeDot) activeDot.classList.add('active');

                        notifications.show("VPN Connection Established", "success");
                    }, 1500);
                } else {
                    btn.innerText = "Connect";
                    btn.classList.remove('connected');
                    status.innerText = "Disconnected";
                    status.style.color = "#94a3b8";
                    dots.forEach(d => d.classList.remove('active'));
                }
            },

            testNetwork: () => {
                const msg = document.getElementById('net-status-msg');
                const detail = document.getElementById('net-details');
                const icon = document.getElementById('net-icon');
                const results = document.getElementById('net-results');

                msg.innerText = "Testing Connection...";
                icon.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
                results.style.opacity = 0.5;

                setTimeout(() => {
                    msg.innerText = "Your connection is secure.";
                    msg.style.color = "#10b981";
                    detail.innerText = "No MITM attacks or packet leaks detected.";
                    icon.innerHTML = '<i class="fa-solid fa-shield-halved"></i>';
                    icon.style.color = "#10b981";

                    results.style.opacity = 1;
                    const ping = Math.floor(Math.random() * 20) + 10;
                    const dl = Math.floor(Math.random() * 500) + 100;

                    results.children[0].children[1].innerText = ping + " ms";
                    results.children[1].children[1].innerText = dl + " Mbps";
                    results.children[2].children[1].innerText = "WPA3";
                    results.children[2].children[1].style.color = "#10b981";

                }, 2000);
            }
        };

        // Auto-run init to register the app
        setTimeout(sentinelApp.init, 500);

        window.addEventListener("DOMContentLoaded", async () => {
            defaultContextMenuHtml = document.getElementById('context-menu').innerHTML;
            window.pendingInstallerConfig = await ipcRenderer.invoke('installer-get-config');
            loadDockApps();
            renderDock();
            renderStartMenuApps();
            const loggedIn = await ipcRenderer.invoke("get-auth-state")
            if (loggedIn) unlockDesktop()
        })

        // --- VIRTUAL FILE SYSTEM (VFS) ---
        class VirtualFS {
            constructor() {
                // Initialize default files if not in storage
                const saved = localStorage.getItem('core_os_vfs');
                if (saved) {
                    this.files = JSON.parse(saved);
                } else {
                    this.files = {
                        'main.js': { content: 'console.log("Welcome to Core OS");', type: 'js' },
                        'style.css': { content: 'body { background: #000; }', type: 'css' },
                        'notes.txt': { content: 'Project Ideas:\n- AI Code Assistant\n- Web OS', type: 'txt' }
                    };
                }
                this.currentFile = 'main.js';
            }

            save() {
                localStorage.setItem('core_os_vfs', JSON.stringify(this.files));
            }

            writeFile(name, content) {
                this.files[name] = { content: content, type: name.split('.').pop() };
                this.save();
                this.refreshUI();
            }

            readFile(name) {
                return this.files[name] ? this.files[name].content : null;
            }

            deleteFile(name) {
                delete this.files[name];
                this.save();
                this.refreshUI();
            }

            listFiles() {
                return Object.keys(this.files);
            }

            // Editor Linkage
            refreshUI() {
                const list = document.getElementById('editor-file-list');
                list.innerHTML = '';
                Object.keys(this.files).forEach(file => {
                    const div = document.createElement('div');
                    div.className = `file-item ${file === this.currentFile ? 'active' : ''}`;
                    // Icon logic
                    let icon = 'fa-file';
                    if (file.endsWith('js')) icon = 'fa-brands fa-js';
                    if (file.endsWith('css')) icon = 'fa-brands fa-css3';
                    if (file.endsWith('html')) icon = 'fa-brands fa-html5';

                    div.innerHTML = `<i class="${icon}"></i> ${file}`;
                    div.onclick = () => this.openInEditor(file);
                    list.appendChild(div);
                });
            }

            openInEditor(filename) {
                this.currentFile = filename;
                document.getElementById('code-area').value = this.files[filename].content;

                // Update tabs
                const tabs = document.getElementById('editor-tabs');
                tabs.innerHTML = `<div class="editor-tab active">${filename} <i class="fa-solid fa-xmark" style="margin-left:10px; font-size:10px;"></i></div>`;

                this.refreshUI();
            }

            saveCurrentFile() {
                const content = document.getElementById('code-area').value;
                this.files[this.currentFile].content = content;
                this.save();
            }

            createFileUI() {
                const name = prompt("Enter file name (e.g., app.js):");
                if (name) {
                    this.writeFile(name, "// New file");
                    notifications.show(`File ${name} created`, 'success');
                }
            }
        }

        const fileSystem = new VirtualFS();

        const openFileInOS = async (filePath) => {
            const error = await ipcRenderer.invoke('fs-open', filePath);
            if (error) {
                notifications.show(`Unable to open file: ${error}`, 'danger');
            }
        };

        const appRegistry = {
            terminal: { name: "Terminal", icon: "fa-terminal", color: "#10b981" },
            code: { name: "AA Code", icon: "fa-code", color: "#3b82f6" },
            git: { name: "GitLens", icon: "fa-brands fa-git-alt", color: "#f97316" },
            explorer: { name: "Explorer", icon: "fa-folder-open", color: "#fbbf24" },
            ai: { name: "All on Admin", icon: "fa-bolt", color: "#8b5cf6" },
            browser: { name: "Browser", icon: "fa-brands fa-chrome", color: "#22c55e" },
            nexus: { name: "Nexus", icon: "fa-search", color: "#ec4899" }, // Pink
            sentinel: { name: "Sentinel", icon: "fa-shield-halved", color: "#38bdf8" },
            photos: { name: "Prism Gallery", icon: "fa-images", color: "#8b5cf6" },
            devtoys: { name: "DevToys", icon: "fa-toolbox", color: "#f59e0b" },
            request: { name: "Request", icon: "fa-satellite-dish", color: "#ff6b6b" },
            sql: { name: "SQL Studio", icon: "fa-database", color: "#48dbfb" },
            markdown: { name: "Markdown", icon: "fa-brands fa-markdown", color: "#feca57" },
            themes: { name: "Themes", icon: "fa-palette", color: "#a8a29e" },
            settings: { name: "Settings", icon: "fa-gear", color: "#9ca3af" }
        };

        const defaultDockApps = ['terminal', 'code', 'explorer', 'flashey', 'browser', 'devtoys', 'request', 'photos', 'nexus', 'themes', 'settings'];
        let dockApps = [];

        function loadDockApps() {
            const saved = localStorage.getItem('core_dock_apps');
            dockApps = saved ? JSON.parse(saved) : [...defaultDockApps];
        }

        function saveDockApps() {
            localStorage.setItem('core_dock_apps', JSON.stringify(dockApps));
        }

        function renderDock() {
            const dock = document.getElementById('dock-apps');
            if (!dock) return;
            dock.innerHTML = '';
            dockApps.forEach(appId => {
                const meta = appRegistry[appId];
                if (!meta) return;
                const el = document.createElement('div');
                el.className = 'app-icon';
                el.style.background = `linear-gradient(135deg, ${meta.color}, #111)`;
                el.style.color = 'white';
                el.onclick = () => appManager.open(appId);
                el.oncontextmenu = (event) => showAppContextMenu(event, appId);
                el.innerHTML = `<i class="fa-solid ${meta.icon}"></i>`;
                dock.appendChild(el);
            });
        }

        function pinAppToDock(appId) {
            if (!dockApps.includes(appId)) {
                dockApps.push(appId);
                saveDockApps();
                renderDock();
                renderStartMenuApps();
            }
        }

        function unpinAppFromDock(appId) {
            dockApps = dockApps.filter(id => id !== appId);
            saveDockApps();
            renderDock();
            renderStartMenuApps();
        }

        function renderStartMenuApps() {
            const pinnedContainer = document.getElementById('pinned-apps');
            const allContainer = document.getElementById('all-apps');
            const query = (document.getElementById('start-search')?.value || '').toLowerCase();

            if (!pinnedContainer || !allContainer) return;
            pinnedContainer.innerHTML = '';
            allContainer.innerHTML = '';

            const renderCard = (container, appId) => {
                const meta = appRegistry[appId];
                if (!meta) return;
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.onclick = () => { appManager.open(appId); toggleStartMenu(); };
                item.oncontextmenu = (event) => showAppContextMenu(event, appId);
                item.innerHTML = `
                            <div style="width:40px; height:40px; background:${meta.color}; border-radius:8px; display:flex; align-items:center; justify-content:center; color:white;">
                                <i class="fa-solid ${meta.icon}"></i>
                            </div>
                            <span style="font-size:12px;">${meta.name}</span>
                        `;
                container.appendChild(item);
            };

            dockApps.forEach(appId => {
                const meta = appRegistry[appId];
                if (!meta) return;
                if (!query || meta.name.toLowerCase().includes(query)) {
                    renderCard(pinnedContainer, appId);
                }
            });

            Object.keys(appRegistry).forEach(appId => {
                const meta = appRegistry[appId];
                if (!meta) return;
                if (!query || meta.name.toLowerCase().includes(query)) {
                    renderCard(allContainer, appId);
                }
            });
        }

        let pendingShortcut = null;
        let defaultContextMenuHtml = "";

        function showAppContextMenu(event, appId) {
            event.preventDefault();
            event.stopPropagation();
            const menu = document.getElementById('context-menu');
            const meta = appRegistry[appId] || { name: appId, icon: "fa-window-maximize", color: "#e4e4e7" };
            const isPinned = dockApps.includes(appId);
            menu.style.display = 'block';
            menu.style.left = `${event.clientX}px`;
            menu.style.top = `${event.clientY}px`;
            menu.innerHTML = `
                        <div class="ctx-item" onclick="queueShortcutPlacement('${appId}')">Make Shortcut</div>
                        <div class="ctx-item" onclick="${isPinned ? `unpinAppFromDock('${appId}')` : `pinAppToDock('${appId}')`}">${isPinned ? 'Remove from Taskbar' : 'Pin to Taskbar'}</div>
                        <div class="ctx-item" onclick="appManager.open('${appId}')">Open ${meta.name}</div>
                    `;
        }

        function queueShortcutPlacement(appId) {
            const meta = appRegistry[appId] || { name: appId, icon: "fa-window-maximize", color: "#e4e4e7" };
            pendingShortcut = {
                name: meta.name,
                path: appId,
                type: "app",
                icon: meta.icon,
                color: meta.color
            };
            notifications.show('Click on the desktop to place the shortcut.', 'success');
            hideContextMenu();
        }

        /* --- FLASHEY (ALL ON ADMIN) LOGIC --- */
        /* --- FLASHEY: THE ULTIMATE COMPANION --- */
        const flasheyApp = {
            config: {
                name: "Flashey",
                mode: null,
                firstRun: true,
                intensity: 5,
                installed: [] // Stores IDs of installed addons
            },
            intervals: [],

            // Addon Registry
            addons: {
                'hivise_core': { name: "Hivise Protocol", icon: "fa-mask", desc: "Unlocks the chaotic Hivise Mode.", type: "mode" },
                'cute_skin': { name: "Cute Pack", icon: "fa-heart", desc: "Makes Flashey pink and kawaii.", type: "skin" },
                'widget_mode': { name: "Desktop Buddy", icon: "fa-clone", desc: "Drag Flashey out of the window.", type: "feature" },
                'focus_helper': { name: "Focus Field", icon: "fa-eye", desc: "Dims background to help you focus.", type: "helper" },
                'clipboard_pro': { name: "ClipMaster", icon: "fa-clipboard", desc: "Remembers your last 5 copies.", type: "helper" },
                'screen_shake': { name: "Earthquake", icon: "fa-house-crack", desc: "Hivise Trolls: Screen shake effect.", type: "troll" }
            },

            init: () => {
                const saved = localStorage.getItem('flashey_config_v2');
                if (saved) flasheyApp.config = JSON.parse(saved);

                flasheyApp.render();
                flasheyApp.applyAddons(); // Apply skins/widgets immediately

                if (flasheyApp.config.mode) flasheyApp.setMode(flasheyApp.config.mode, true);

                // Listener for Code Helper
                document.addEventListener('keyup', flasheyApp.handleTyping);
                // Listener for Clipboard Addon
                document.addEventListener('copy', flasheyApp.handleCopy);
            },

            save: () => {
                localStorage.setItem('flashey_config_v2', JSON.stringify(flasheyApp.config));
            },

            render: () => {
                // Handle First Run / Onboarding
                if (flasheyApp.config.firstRun) {
                    document.getElementById('flashey-onboarding').classList.remove('hidden');
                    document.getElementById('flashey-dashboard').style.display = 'none';
                } else {
                    document.getElementById('flashey-onboarding').classList.add('hidden');
                    document.getElementById('flashey-dashboard').style.display = 'flex';
                }

                // Update Names
                document.getElementById('intro-name').innerText = flasheyApp.config.name;
                document.getElementById('flashey-display-name').innerText = flasheyApp.config.name;
                document.getElementById('flashey-rename').value = flasheyApp.config.name;

                // Check Addon Dependencies for UI
                const hasHivise = flasheyApp.config.installed.includes('hivise_core');
                document.getElementById('hivise-config-card').style.display = hasHivise ? 'block' : 'none';

                // Lock Hivise Button if not installed
                const hivBtn = document.querySelector("div[onclick=\"flasheyApp.setMode('hivise')\"]");
                if (hivBtn) {
                    if (!hasHivise) {
                        hivBtn.style.opacity = '0.5';
                        hivBtn.onclick = () => notifications.show("Install 'Hivise Protocol' from Addons to unlock.", "error");
                        hivBtn.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#ef4444;font-weight:bold;"><i class="fa-solid fa-lock"></i> Hivise Mode</span></div>`;
                    } else {
                        hivBtn.style.opacity = '1';
                        hivBtn.onclick = () => flasheyApp.setMode('hivise');
                        hivBtn.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#ef4444;font-weight:bold;"><i class="fa-solid fa-mask"></i> Hivise Mode</span><div id="ind-hivise" style="width:10px;height:10px;border-radius:50%;background:#333;"></div></div>`;
                    }
                }
            },

            applyAddons: () => {
                const installed = flasheyApp.config.installed;
                const mainAvatar = document.getElementById('flashey-avatar');
                const widget = document.getElementById('flashey-widget');

                // 1. Cute Skin
                if (installed.includes('cute_skin')) {
                    mainAvatar.classList.add('skin-cute');
                    widget.classList.add('skin-cute');
                } else {
                    mainAvatar.classList.remove('skin-cute');
                    widget.classList.remove('skin-cute');
                }

                // 2. Widget Mode
                if (installed.includes('widget_mode')) {
                    // Show toggle in dashboard or just enable the behavior?
                    // Let's add a button in dashboard to "Pop Out"
                    let popBtn = document.getElementById('flashey-popout-btn');
                    if (!popBtn) {
                        popBtn = document.createElement('button');
                        popBtn.id = 'flashey-popout-btn';
                        popBtn.className = 'flashey-btn';
                        popBtn.style.marginTop = '10px';
                        popBtn.innerHTML = '<i class="fa-solid fa-up-right-from-square"></i> Switch to Widget';
                        popBtn.onclick = flasheyApp.toggleWidgetMode;
                        document.getElementById('flashey-dashboard').appendChild(popBtn);
                    }
                }
            },

            /* --- MODES --- */
            setMode: (mode, force = false) => {
                if (!force && flasheyApp.config.mode === mode) {
                    flasheyApp.stopAll();
                    flasheyApp.config.mode = null;
                } else {
                    flasheyApp.stopAll();
                    flasheyApp.config.mode = mode;
                    if (mode === 'helping') flasheyApp.startHelping();
                    if (mode === 'hivise') flasheyApp.startHivise();
                }
                flasheyApp.save();
                flasheyApp.updateUIState();
            },

            updateUIState: () => {
                // Standard UI updates (colors, status text)
                const avatar = document.getElementById('flashey-avatar');
                const status = document.getElementById('flashey-status');
                const indHelp = document.getElementById('ind-helping');
                const indHiv = document.getElementById('ind-hivise');

                // Reset
                avatar.classList.remove('mode-helping', 'mode-hivise');
                if (indHelp) indHelp.style.background = '#333';
                if (indHiv) indHiv.style.background = '#333';

                if (flasheyApp.config.mode === 'helping') {
                    avatar.classList.add('mode-helping');
                    status.innerText = "Systems Optimal. Helping enabled.";
                    if (indHelp) {
                        indHelp.style.background = '#38bdf8';
                        indHelp.style.boxShadow = '0 0 10px #38bdf8';
                    }
                } else if (flasheyApp.config.mode === 'hivise') {
                    avatar.classList.add('mode-hivise');
                    status.innerText = "Chaos Active.";
                    if (indHiv) {
                        indHiv.style.background = '#ef4444';
                        indHiv.style.boxShadow = '0 0 10px #ef4444';
                    }
                } else {
                    status.innerText = "Standby.";
                }
            },

            stopAll: () => {
                flasheyApp.intervals.forEach(clearInterval);
                flasheyApp.intervals = [];
                // Remove Focus Overlay
                document.getElementById('focus-overlay').style.opacity = 0;
                // Stop Shake
                document.body.style.animation = '';
            },

            /* --- HELPING CORE (ENHANCED) --- */
            startHelping: () => {
                const installed = flasheyApp.config.installed;
                notifications.show(`${flasheyApp.config.name}: I'm here to help!`, 'success');

                // Feature 1: Focus Mode (Addon)
                if (installed.includes('focus_helper')) {
                    const overlay = document.getElementById('focus-overlay');
                    overlay.style.opacity = 1;
                    // Logic to keep overlay behind active window is handled by CSS z-index management usually
                    // but for simplicity, we just dim the background.
                }

                // Feature 2: Smart Suggestions (Core)
                // (Existing typing logic in handleTyping)
            },

            handleTyping: (e) => {
                if (flasheyApp.config.mode !== 'helping') return;

                // Basic Auto-Finishers
                const active = document.activeElement;
                if (active.tagName === 'TEXTAREA' || (active.tagName === 'INPUT' && active.type === 'text')) {
                    const val = active.value;

                    // Auto Close Brackets
                    if (e.key === '{') { /* insert } */ }
                    if (e.key === '(') { /* insert ) */ }

                    // Code Helper Popup logic (Simplified)
                    if (val.endsWith('function')) {
                        flasheyApp.showHelperPopup(active, "Generate function boilerplate? (Press Tab)");
                        active.onkeydown = (k) => {
                            if (k.key === 'Tab') {
                                k.preventDefault();
                                const snippet = " name() {\n    // code here\n}";
                                active.setRangeText(snippet, active.selectionStart, active.selectionEnd, "end");
                                document.getElementById('flashey-helper-popup').style.display = 'none';
                                active.onkeydown = null;
                            }
                        }
                    }
                }
            },

            handleCopy: (e) => {
                if (flasheyApp.config.mode === 'helping' && flasheyApp.config.installed.includes('clipboard_pro')) {
                    const selection = document.getSelection().toString();
                    if (selection) {
                        notifications.show("Saved to ClipMaster", "success");
                        // In a real app, you'd store this in an array to paste later
                    }
                }
            },

            showHelperPopup: (target, text) => {
                const popup = document.getElementById('flashey-helper-popup');
                if (!popup) return;
                const rect = target.getBoundingClientRect();
                popup.style.left = rect.left + 'px';
                popup.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                popup.style.display = 'block';
                popup.innerText = text;
                setTimeout(() => popup.style.display = 'none', 5000);
            },

            /* --- HIVISE MODE (ADDON LOCKED) --- */
            startHivise: () => {
                if (!flasheyApp.config.installed.includes('hivise_core')) return;

                notifications.show("Hivise: Let the games begin.", "warning");
                const intensity = flasheyApp.config.intensity;

                const loop = setInterval(() => {
                    const roll = Math.random() * 100;

                    // 1. Screen Shake (Addon)
                    if (flasheyApp.config.installed.includes('screen_shake') && roll < 10) {
                        document.body.style.animation = "shake 0.5s";
                        setTimeout(() => document.body.style.animation = '', 500);
                    }

                    // 2. Random Pigeons (Core Hivise)
                    if (roll > 20 && roll < 35) flasheyApp.spawnPigeon();

                    // 3. Troll Windows (Core Hivise)
                    if (roll > 50 && roll < 50 + (intensity * 2)) flasheyApp.spawnTrollWindow();

                }, 12000 - (intensity * 1000));

                flasheyApp.intervals.push(loop);
            },

            spawnPigeon: () => {
                const img = document.createElement('img');
                img.src = "https://cdn.pixabay.com/photo/2020/02/27/13/21/rock-dove-4884627_1280.jpg";
                img.className = "pigeon-overlay";
                img.style.top = Math.random() * (window.innerHeight - 200) + 'px';
                document.body.appendChild(img);
                setTimeout(() => img.remove(), 4000);
            },

            spawnTrollWindow: () => {
                // Same troll window logic as before
                const div = document.createElement('div');
                div.className = "window";
                div.style = `left:${Math.random() * (window.innerWidth - 300)}px; top:${Math.random() * (window.innerHeight - 200)}px; width:300px; z-index:9000; position:absolute;`;
                div.innerHTML = `
            <div class="title-bar" style="background:#ef4444;"><div class="win-title">OOPS</div></div>
            <div class="window-content" style="padding:20px; background:#18181b; color:white;">
                Deleting System32... <br>
                <div style="background:#333; height:5px; width:100%; margin-top:10px;"><div style="background:red; height:100%; width:${Math.random() * 100}%"></div></div>
            </div>`;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 4000);
            },

            /* --- WIDGET LOGIC --- */
            toggleWidgetMode: () => {
                const win = document.getElementById('win-flashey');
                const widget = document.getElementById('flashey-widget');

                if (win.classList.contains('hidden')) {
                    // Restore Window
                    win.classList.remove('hidden');
                    widget.style.display = 'none';
                } else {
                    // Go to Widget
                    win.classList.add('hidden');
                    widget.style.display = 'flex';
                    widget.style.left = (window.innerWidth - 150) + 'px';
                    widget.style.top = '50px';

                    // Widget Interaction
                    widget.ondblclick = () => flasheyApp.toggleWidgetMode(); // Dbl click to open app
                }
            },

            // Core helpers
            completeOnboarding: () => { flasheyApp.config.firstRun = false; flasheyApp.save(); flasheyApp.render(); },
            rename: (n) => { flasheyApp.config.name = n; flasheyApp.save(); flasheyApp.render(); },
            toggleSettings: () => {
                const el = document.getElementById('flashey-settings');
                el.style.transform = el.style.transform === 'translateX(0%)' ? 'translateX(100%)' : 'translateX(0%)';
            },
            reset: () => {
                localStorage.removeItem('flashey_config_v2');
                location.reload();
            }
        };

        /* --- APP: NEXUS (Finder/Search Engine) --- */
        const nexusApp = {
            isOpen: false,

            toggle() {
                const win = document.getElementById('win-nexus');
                const input = document.getElementById('nexus-input');
                if (!win) return;

                win.classList.toggle('hidden');
                this.isOpen = !win.classList.contains('hidden');

                if (this.isOpen) {
                    win.style.left = '50%';
                    win.style.top = '100px';
                    win.style.transform = 'translateX(-50%)';
                    input.value = '';
                    input.focus();
                    this.search('');
                }
            },

            search(query) {
                const container = document.getElementById('nexus-results');
                if (!container) return;

                container.innerHTML = '';
                const q = query.toLowerCase();

                if (window.appRegistry) {
                    const apps = Object.entries(appRegistry)
                        .map(([id, app]) => ({
                            id,
                            app,
                            score: q && app.name.toLowerCase().includes(q) ? 1 : 0
                        }))
                        .sort((a, b) => b.score - a.score);

                    apps.forEach(({ id, app }) => {
                        if (q && !app.name.toLowerCase().includes(q)) return;

                        this.createResultItem(
                            container,
                            app.icon,
                            app.name,
                            "Application",
                            () => {
                                appManager.open(id);
                                this.toggle();
                            },
                            app.color
                        );
                    });
                }

                if (q.length > 0) {
                    this.createResultItem(
                        container,
                        "fa-globe",
                        `Search Google`,
                        query,
                        () => this.openBrowserSearch(query),
                        "#3b82f6"
                    );
                }
            },

            openBrowserSearch(query) {
                const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;

                appManager.open('browser');

                if (window.browserApp?.navigate) {
                    browserApp.navigate(url);
                } else {
                    const input = document.getElementById('browser-url');
                    const frame = document.getElementById('browser-frame');
                    if (input && frame) {
                        input.value = url;
                        frame.src = url;
                    }
                }

                this.toggle();
            },

            createResultItem(container, icon, title, subtitle, onClick, color) {
                const el = document.createElement('div');
                el.className = 'nexus-item';
                el.onclick = onClick;

                el.innerHTML = `
            <div style="font-size:24px;color:${color};width:40px;text-align:center">
                <i class="fa-solid ${icon}"></i>
            </div>
            <div style="flex:1">
                <div style="font-size:16px;font-weight:500;color:#fff">${title}</div>
                <div style="font-size:12px;color:#a1a1aa">${subtitle}</div>
            </div>
            <i class="fa-solid fa-arrow-right" style="color:#52525b"></i>
        `;

                container.appendChild(el);
            },

            handleKey(e) {
                if (e.key === 'Escape') this.toggle();
                if (e.key === 'Enter') {
                    document.querySelector('.nexus-item')?.click();
                }
            }
        };

        /* --- SAFE appManager hook --- */
        if (window.appManager?.open) {
            const _open = appManager.open.bind(appManager);
            appManager.open = (id) => {
                if (id === 'nexus') {
                    nexusApp.toggle();
                    return;
                }
                _open(id);
            };
        }


        const prismApp = {
            stream: null,

            async loadLibrary() {
                if (!window.ipcRenderer) return;

                const grid = document.getElementById('prism-grid');
                if (!grid || grid.dataset.loaded === 'true') return;

                const result = await ipcRenderer.invoke('photos-get-library');
                grid.innerHTML = '';

                if (result?.error) {
                    grid.innerHTML = `<div style="padding:20px;color:var(--danger)">${result.error}</div>`;
                    return;
                }

                result.images?.forEach(img => {
                    const card = document.createElement('div');
                    card.className = 'prism-img-card';
                    card.onclick = () => {
                        document.getElementById('desktop')?.style.setProperty(
                            'background-image',
                            `url('${img.src}')`
                        );
                        notifications?.show?.("Wallpaper Updated", "success");
                    };
                    card.innerHTML = `<img src="${img.src}" loading="lazy">`;
                    grid.appendChild(card);
                });

                grid.dataset.loaded = 'true';
            },

            async startCamera() {
                const video = document.getElementById('camera-feed');
                if (!video) return;

                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = this.stream;
                } catch {
                    notifications?.show?.("Camera unavailable", "danger");
                }
            },

            stopCamera() {
                this.stream?.getTracks().forEach(t => t.stop());
                this.stream = null;
            }
        };

        if (window.appManager?.close) {
            const _close = appManager.close.bind(appManager);
            appManager.close = (id) => {
                if (id === 'photos') prismApp.stopCamera();
                _close(id);
            };
        }


        /* --- ADDON STORE LOGIC --- */
        const flasheyStore = {
            open: () => {
                document.getElementById('win-flashey-store').classList.remove('hidden');
                appManager.bringToFront('flashey-store'); // Ensure you have this capability or manually set zIndex
                flasheyStore.render();
            },

            filter: (query) => {
                flasheyStore.render(query.toLowerCase());
            },

            render: (filter = "") => {
                const grid = document.getElementById('flashey-store-list');
                grid.innerHTML = "";

                Object.keys(flasheyApp.addons).forEach(id => {
                    const addon = flasheyApp.addons[id];
                    if (filter && !addon.name.toLowerCase().includes(filter)) return;

                    const isInstalled = flasheyApp.config.installed.includes(id);

                    const card = document.createElement('div');
                    card.className = "addon-card";
                    card.innerHTML = `
                <i class="fa-solid ${addon.icon} addon-icon"></i>
                <div class="addon-title">${addon.name}</div>
                <div class="addon-desc">${addon.desc}</div>
                <button class="install-btn ${isInstalled ? 'installed' : ''}" onclick="flasheyStore.install('${id}', this)">
                    ${isInstalled ? 'Installed' : 'Download'}
                </button>
                <div class="dl-bar"></div>
            `;
                    grid.appendChild(card);
                });
            },

            install: (id, btn) => {
                // Simulate Download
                const card = btn.parentElement;
                const bar = card.querySelector('.dl-bar');
                btn.innerText = "Downloading...";
                btn.style.opacity = 0.7;

                let progress = 0;
                const int = setInterval(() => {
                    progress += Math.random() * 20;
                    bar.style.width = progress + '%';

                    if (progress >= 100) {
                        clearInterval(int);
                        flasheyApp.config.installed.push(id);
                        flasheyApp.save();
                        flasheyApp.render(); // Re-render main UI to unlock things
                        flasheyApp.applyAddons(); // Apply visual changes

                        btn.innerText = "Installed";
                        btn.classList.add('installed');
                        btn.style.opacity = 1;
                        bar.style.width = '0%';

                        notifications.show(`Addon "${flasheyApp.addons[id].name}" installed!`, "success");
                    }
                }, 200);
            }
        };

        // --- INITIALIZATION ---
        // Add 'flashey-store' to your appRegistry if you want it in the window list, 
        // or just treat it as a sub-window.
        setTimeout(flasheyApp.init, 1000);

        // Add keyframes for shake
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
        @keyframes shake {
          0% { transform: translate(1px, 1px) rotate(0deg); }
          10% { transform: translate(-1px, -2px) rotate(-1deg); }
          20% { transform: translate(-3px, 0px) rotate(1deg); }
          30% { transform: translate(3px, 2px) rotate(0deg); }
          40% { transform: translate(1px, -1px) rotate(1deg); }
          50% { transform: translate(-1px, 2px) rotate(-1deg); }
          60% { transform: translate(-3px, 1px) rotate(0deg); }
          70% { transform: translate(3px, 1px) rotate(-1deg); }
          80% { transform: translate(-1px, -1px) rotate(1deg); }
          90% { transform: translate(1px, 2px) rotate(0deg); }
          100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        `;
        document.head.appendChild(styleSheet);

        // --- REAL FILE SYSTEM INTEGRATION ---
        const explorerApp = {
            currentPath: '',
            special: {
                root: "__ROOT__",
                home: "",
                downloads: "",
                documents: "",
                desktop: ""
            },

            init: async () => {
                const specialPaths = await ipcRenderer.invoke('fs-special-paths');
                explorerApp.special = { ...explorerApp.special, ...specialPaths };
                await explorerApp.navigate(explorerApp.special.home);
            },

            navigate: async (dirPath) => {
                // 1. Ask Main Process for files (requires the main.js update from before)
                const result = await ipcRenderer.invoke('fs-read-dir', dirPath);

                if (result.error) {
                    notifications.show(`Error: ${result.error}`, 'danger');
                    return;
                }

                // 2. Update State
                explorerApp.currentPath = result.path;

                // 3. Update Address Bar
                const addrBar = document.getElementById('exp-path');
                if (addrBar) addrBar.value = result.path;

                // 4. Render Grid
                explorerApp.render(result.files);
            },

            render: (files) => {
                const grid = document.getElementById('file-grid');
                grid.innerHTML = ''; // Clear existing items

                files.forEach(file => {
                    const el = document.createElement('div');
                    el.className = 'file-icon';

                    // Determine Icon & Color
                    let iconClass = 'fa-file';
                    let color = '#a1a1aa'; // Default gray

                    if (file.isDirectory) {
                        iconClass = 'fa-folder';
                        color = '#fbbf24'; // Folder Yellow
                    } else if (file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        iconClass = 'fa-file-image';
                        color = '#818cf8'; // Indigo
                    } else if (file.name.match(/\.(js|html|css|json|py)$/i)) {
                        iconClass = 'fa-file-code';
                        color = '#34d399'; // Green
                    } else if (file.name.endsWith('.pdf')) {
                        iconClass = 'fa-file-pdf';
                        color = '#f87171'; // Red
                    } else if (file.name.endsWith('.zip') || file.name.endsWith('.rar')) {
                        iconClass = 'fa-file-zipper';
                        color = '#fcd34d';
                    }

                    el.onmousedown = (e) => {
                        if (e.button !== 0) return;
                        dragManager.start(e, 'new-item', {
                            name: file.name,
                            path: file.path,
                            type: 'file',
                            icon: file.isDirectory ? 'fa-folder' : 'fa-file',
                            color: file.isDirectory ? '#fbbf24' : '#a1a1aa'
                        });
                    };

                    // HTML Structure matching your CSS
                    el.innerHTML = `
                                <div class="f-img"><i class="fa-solid ${iconClass}" style="color: ${color}"></i></div>
                                <div class="f-name">${file.name}</div>
                            `;

                    // Double Click to Open/Enter
                    el.ondblclick = () => {
                        if (file.isDirectory) {
                            explorerApp.navigate(file.path);
                        } else {
                            // Open file in default OS app
                            openFileInOS(file.path);
                        }
                    }

                    // Single click for selection visual
                    el.onclick = () => {
                        document.querySelectorAll('.file-icon').forEach(i => i.classList.remove('selected'));
                        el.classList.add('selected');
                    };

                    grid.appendChild(el);
                });
            },

            goUp: () => {
                // Calculate parent directory
                const parent = pathModule.dirname(explorerApp.currentPath);
                if (parent && parent !== explorerApp.currentPath) {
                    explorerApp.navigate(parent);
                }
            },

            refresh: () => {
                explorerApp.navigate(explorerApp.currentPath);
            },

            newFolder: async () => {
                const name = prompt("Folder Name:");
                if (!name) return;
                if (!explorerApp.currentPath || explorerApp.currentPath === "__ROOT__") {
                    notifications.show("Open a folder before creating items.", "warning");
                    return;
                }
                await ipcRenderer.invoke('fs-create-folder', pathModule.join(explorerApp.currentPath, name));
                explorerApp.navigate(explorerApp.currentPath); // Refresh
            },

            newFile: async () => {
                const name = prompt("File Name:");
                if (!name) return;
                if (!explorerApp.currentPath || explorerApp.currentPath === "__ROOT__") {
                    notifications.show("Open a folder before creating items.", "warning");
                    return;
                }
                await ipcRenderer.invoke('fs-create-file', pathModule.join(explorerApp.currentPath, name));
                explorerApp.navigate(explorerApp.currentPath); // Refresh
            },

            // UPDATE your navigate/render loop to add drag listeners:
            // Inside where you create the file elements:
            // el.onmousedown = (e) => dragManager.start(e, 'new-item', {
            //      name: f.name,
            //      path: f.path,
            //      type: 'file',
            //      icon: f.isDirectory ? 'fa-folder' : 'fa-file',
            //      color: '#fff'
            // });
        };

        // Initialize Explorer when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            explorerApp.init();
            wifiManager.updateIcon();
            wifiManager.render();
        });

        // 1. Settings Persistence
        function saveSettings() {
            const settings = {
                // Gather whatever settings you have
                accent: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
                // ... add others
            };
            localStorage.setItem('core_settings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('core_settings');
            if (saved) {
                const s = JSON.parse(saved);
                if (s.accent) document.documentElement.style.setProperty('--accent', s.accent);
            }
        }
        // Call loadSettings() on startup. Call saveSettings() whenever a setting changes.

        // 2. VS Code Persistence
        const codeEditor = document.getElementById('code-editor'); // Assuming textarea ID
        if (codeEditor) {
            codeEditor.value = localStorage.getItem('vs_code_content') || "";
            codeEditor.addEventListener('input', () => {
                localStorage.setItem('vs_code_content', codeEditor.value);
            });
        }

        /* --- UPGRADED BROWSER ENGINE --- */
        const browserApp = {
            view: null,
            bar: null,
            loader: null,
            adBlockerEnabled: false,

            init: () => {
                // Grab elements
                browserApp.view = document.getElementById('browser-view');
                browserApp.bar = document.getElementById('browser-url');
                browserApp.loader = document.getElementById('browser-loader');

                // Listen for load events to update UI
                browserApp.view.addEventListener('did-start-loading', () => {
                    browserApp.loader.style.width = '20%';
                    browserApp.loader.style.opacity = '1';
                });

                browserApp.view.addEventListener('did-stop-loading', () => {
                    browserApp.loader.style.width = '100%';
                    setTimeout(() => { browserApp.loader.style.opacity = '0'; }, 200);

                    // Sync URL bar with actual URL (in case user clicked a link)
                    browserApp.bar.value = browserApp.view.getURL();
                    browserApp.applyAdBlocker();
                });

                browserApp.view.addEventListener('did-fail-load', (e) => {
                    // Handle simple errors (optional)
                    console.log("Failed to load:", e);
                });

                // Open links in same window (prevent popups from spawning new Electron windows)
                browserApp.view.addEventListener('new-window', (e) => {
                    browserApp.view.loadURL(e.url);
                });
            },

            handleInput: (e) => {
                if (e.key === 'Enter') {
                    let val = browserApp.bar.value.trim();

                    // Smart Search Logic
                    if (val.includes(' ') || !val.includes('.')) {
                        // Treat as search query
                        val = 'https://www.google.com/search?q=' + encodeURIComponent(val);
                    } else {
                        // Treat as URL
                        if (!val.startsWith('http')) val = 'https://' + val;
                    }

                    browserApp.view.loadURL(val);
                    browserApp.bar.value = val; // Update bar immediately
                    browserApp.view.focus();
                }
            },

            back: () => {
                if (browserApp.view.canGoBack()) browserApp.view.goBack();
            },

            forward: () => {
                if (browserApp.view.canGoForward()) browserApp.view.goForward();
            },

            reload: () => {
                browserApp.view.reload();
            },

            setAdBlocker: (enabled) => {
                browserApp.adBlockerEnabled = enabled;
                if (enabled) {
                    browserApp.applyAdBlocker(true);
                }
            },

            applyAdBlocker: (force = false) => {
                if (!browserApp.view || (!browserApp.adBlockerEnabled && !force)) return;
                const adBlockScript = `
                                (function(){
                                    const selectors = [
                                        'iframe[src*="ad"]',
                                        '[id*="ad-"]',
                                        '[class*="ad-"]',
                                        '[class*="ads"]',
                                        '[data-ad]',
                                        'ytd-display-ad-renderer',
                                        'ytd-promoted-video-renderer',
                                        'ytd-infeed-ad-layout-renderer',
                                        '.video-ads',
                                        '.ytp-ad-player-overlay'
                                    ];
                                    selectors.forEach(sel => {
                                        document.querySelectorAll(sel).forEach(el => el.remove());
                                    });
                                })();
                            `;
                const youtubeScript = `
                                (function(){
                                    if (window.__coreAdBlockInterval) return;
                                    window.__coreAdBlockInterval = setInterval(function(){
                                        try {
                                            const video = document.querySelector('video');
                                            if (!video) return;
                                            const skip = document.querySelector('.ytp-ad-skip-button-modern, .ytp-ad-skip-button');
                                            const isAd = document.body.classList.contains('ad-showing') || document.querySelector('.ad-showing');
                                            if (isAd && video.duration) {
                                                video.currentTime = video.duration;
                                            }
                                            if (skip) {
                                                skip.click();
                                            }
                                        } catch (e) {}
                                    }, 1500);
                                })();
                            `;
                browserApp.view.executeJavaScript(adBlockScript, true);
                browserApp.view.executeJavaScript(youtubeScript, true);
            }
        };

        // Initialize the browser listeners once the DOM is ready
        window.addEventListener('DOMContentLoaded', () => {
            // We need a slight timeout to ensure the webview element is registered by Electron
            setTimeout(browserApp.init, 1000);
        });

        /* --- SYSTEM CONFIG & PERSISTENCE --- */
        const systemConfig = {
            state: {
                username: "Senior Dev",
                userTitle: "Core OS Security",
                accent: '#6366f1',
                glassOpacity: 0.6,
                glassBlur: '20px',
                font: "'JetBrains Mono', monospace",
                wallpaperIndex: 0,
                visualStyle: 'glass',
                showSeconds: false,
                adBlockerEnabled: false,
                customWallpaperUrl: null,
                passwordEnabled: false,
                passwordValue: '',
                swipeToUnlock: false,
                themeName: 'default'
            },

            init() {
                // Load settings from local storage
                const saved = localStorage.getItem('core_os_config');
                if (saved) {
                    this.state = { ...this.state, ...JSON.parse(saved) };
                }
                if (document.getElementById('set-username')) {
                    document.getElementById('set-username').value = this.state.username;
                    document.getElementById('set-title').value = this.state.userTitle;
                }
                if (window.pendingInstallerConfig) {
                    const config = window.pendingInstallerConfig;
                    if (typeof config.wallpaper === 'number') {
                        this.state.wallpaperIndex = config.wallpaper;
                    }
                    if (config.wallpaperUrl) {
                        this.state.customWallpaperUrl = config.wallpaperUrl;
                    }
                }
                this.apply();
                this.updateProfilePreview();
            },

            save() {
                localStorage.setItem('core_os_config', JSON.stringify(this.state));
            },

            updateProfilePreview() {
                // Real-time preview in settings
                const newName = document.getElementById('set-username').value || "User";
                const newTitle = document.getElementById('set-title').value || "Operator";
                document.getElementById('preview-username').innerText = newName;
                document.getElementById('preview-title').innerText = newTitle;
            },

            saveProfile() {
                const newName = document.getElementById('set-username').value.trim();
                const newTitle = document.getElementById('set-title').value.trim();

                if (!newName) {
                    notifications.show("Username cannot be empty", "warning");
                    return;
                }

                this.state.username = newName;
                this.state.userTitle = newTitle;
                this.save();
                this.apply(); // Updates login screen
                terminalApp.init(); // Updates terminal prompt
                notifications.show("Profile Updated", "success");
            },

            apply() {
                const r = document.documentElement;
                if (themeManager && themeManager.applyTheme) {
                    themeManager.applyTheme(this.state.themeName);
                }
                r.style.setProperty('--accent', this.state.accent);
                r.style.setProperty('--accent-hover', this.state.accent);
                r.style.setProperty('--glass-opacity', this.state.glassOpacity);
                r.style.setProperty('--glass-blur', this.state.glassBlur);
                r.style.setProperty('--font-mono', this.state.font);
                r.style.setProperty('--settings-surface', this.state.visualStyle === 'prism'
                    ? 'linear-gradient(135deg, rgba(82, 59, 177, 0.35), rgba(22, 163, 174, 0.25), rgba(14, 116, 144, 0.2))'
                    : 'rgba(10, 10, 14, 0.85)');
                r.style.setProperty('--settings-border', this.state.visualStyle === 'prism'
                    ? 'rgba(125, 211, 252, 0.25)'
                    : 'rgba(255, 255, 255, 0.08)');
                r.style.setProperty('--settings-glow', this.state.visualStyle === 'prism'
                    ? '0 18px 35px rgba(56, 189, 248, 0.25)'
                    : '0 18px 30px rgba(0, 0, 0, 0.4)');

                // Update slider texts if settings window is open
                document.getElementById('val-opacity').innerText = Math.round(this.state.glassOpacity * 100) + '%';
                document.getElementById('val-blur').innerText = this.state.glassBlur;
                const toggleSeconds = document.getElementById('toggle-seconds');
                if (toggleSeconds) toggleSeconds.checked = this.state.showSeconds;
                const toggleAdblock = document.getElementById('toggle-adblock');
                if (toggleAdblock) toggleAdblock.checked = this.state.adBlockerEnabled;
                const togglePasswordRequired = document.getElementById('toggle-password-required');
                if (togglePasswordRequired) togglePasswordRequired.checked = this.state.passwordEnabled;
                const toggleSwipeUnlock = document.getElementById('toggle-swipe-unlock');
                if (toggleSwipeUnlock) toggleSwipeUnlock.checked = this.state.swipeToUnlock;
                const passwordStatus = document.getElementById('password-status');
                if (passwordStatus) {
                    passwordStatus.innerText = this.state.passwordEnabled
                        ? (this.state.passwordValue ? 'Password enabled.' : 'Password enabled. Set a password to lock.')
                        : 'Password disabled. Any password will unlock.';
                }
                const loginSwipeUi = document.getElementById('login-swipe-ui');
                if (loginSwipeUi) loginSwipeUi.classList.toggle('hidden', !this.state.swipeToUnlock);
                const loginInput = document.getElementById('password-input');
                if (loginInput) {
                    loginInput.placeholder = this.state.passwordEnabled
                        ? 'Enter Password'
                        : 'Enter Password (any)';
                }
                const glassBtn = document.getElementById('style-glass');
                const prismBtn = document.getElementById('style-prism');
                if (glassBtn && prismBtn) {
                    glassBtn.classList.toggle('active', this.state.visualStyle === 'glass');
                    prismBtn.classList.toggle('active', this.state.visualStyle === 'prism');
                }
                const desktop = document.getElementById('desktop');
                const loginScreen = document.getElementById('login-screen');
                const shouldApplyWallpaper = this.state.themeName === 'default' || !!this.state.customWallpaperUrl;
                if (desktop && typeof wallpapers !== 'undefined' && shouldApplyWallpaper) {
                    if (this.state.customWallpaperUrl) {
                        if (!wallpapers.includes(this.state.customWallpaperUrl)) {
                            wallpapers.unshift(this.state.customWallpaperUrl);
                            this.state.wallpaperIndex = 0;
                        }
                    }
                    const activeWallpaper = wallpapers[this.state.wallpaperIndex];
                    desktop.style.backgroundImage = `url('${activeWallpaper}')`;
                    if (loginScreen) loginScreen.style.backgroundImage = `url('${activeWallpaper}')`;
                }
                if (browserApp && browserApp.setAdBlocker) {
                    browserApp.setAdBlocker(this.state.adBlockerEnabled);
                }

                const loginCard = document.querySelector('.login-card');
                if (loginCard) {
                    loginCard.querySelector('h2').innerText = this.state.username;
                    loginCard.querySelector('p').innerText = this.state.userTitle;
                }
            },

            setAccent(color) {
                this.state.accent = color;
                this.save();
                this.apply();
            },

            setGlass(type, val) {
                if (type === 'opacity') {
                    this.state.glassOpacity = val / 100;
                    document.getElementById('val-opacity').innerText = val + '%';
                }
                if (type === 'blur') {
                    this.state.glassBlur = val + 'px';
                    document.getElementById('val-blur').innerText = val + 'px';
                }
                this.save();
                this.apply();
            },

            setFont(fontName) {
                this.state.font = fontName;
                this.save();
                this.apply();
            },

            setVisualStyle(style) {
                this.state.visualStyle = style;
                this.save();
                this.apply();
            },

            setShowSeconds(enabled) {
                this.state.showSeconds = enabled;
                this.save();
                updateClock();
            },

            setWallpaper(index) {
                this.state.wallpaperIndex = index;
                this.save();
                this.apply();
            },

            setAdBlocker(enabled) {
                this.state.adBlockerEnabled = enabled;
                this.save();
                this.apply();
                notifications.show(enabled ? 'Ad Blocker enabled' : 'Ad Blocker disabled', 'success');
            },

            setPasswordEnabled(enabled) {
                this.state.passwordEnabled = enabled;
                this.save();
                this.apply();
                notifications.show(enabled ? 'Password required on unlock.' : 'Password disabled. Any password works.', enabled ? 'success' : 'warning');
            },

            updatePassword() {
                const input = document.getElementById('password-setting');
                if (!input) return;
                const value = input.value.trim();
                if (!value) {
                    notifications.show('Password cannot be empty.', 'warning');
                    return;
                }
                this.state.passwordValue = value;
                this.save();
                this.apply();
                input.value = '';
                notifications.show('Password saved.', 'success');
            },

            setSwipeToUnlock(enabled) {
                this.state.swipeToUnlock = enabled;
                this.save();
                this.apply();
                notifications.show(enabled ? 'Swipe to unlock enabled.' : 'Swipe to unlock disabled.', 'success');
            },

            setTheme(themeName) {
                this.state.themeName = themeName;
                if (themeName === 'matrix') this.state.accent = '#00ff41';
                if (themeName === 'synth') this.state.accent = '#ff00ff';
                if (themeName === 'nord') this.state.accent = '#88c0d0';
                if (themeName === 'spiderpunk') this.state.accent = '#ff3d8b';
                if (themeName === 'default') this.state.accent = '#6366f1';
                else {
                    this.state.customWallpaperUrl = null;
                }
                this.save();
                this.apply();
            },

            rebootInstaller: async () => {
                const result = await ipcRenderer.invoke('installer-reset');
                if (result?.error) {
                    notifications.show(result.error, 'danger');
                }
            },

            reset() {
                localStorage.clear();
                location.reload();
            }
        };

        function browserLoaded() {
            const loader = document.getElementById('browser-loader');
            loader.style.width = '100%';
            setTimeout(() => { loader.style.width = '0%'; }, 500);
        }

        function reloadBrowser() {
            const frame = document.getElementById('browser-frame');
            document.getElementById('browser-loader').style.width = '70%';
            frame.src = frame.src;
        }

        const desktopManager = {
            shortcuts: [],

            init: () => {
                // Load from storage
                const saved = localStorage.getItem('core_shortcuts');
                if (saved) desktopManager.shortcuts = JSON.parse(saved);
                desktopManager.render();

                // Global click to hide context menu
                window.addEventListener('click', () => document.getElementById('context-menu').style.display = 'none');
            },

            save: () => localStorage.setItem('core_shortcuts', JSON.stringify(desktopManager.shortcuts)),

            addShortcut: (data, x, y) => {
                const id = Date.now().toString();
                desktopManager.shortcuts.push({
                    id,
                    name: data.name,
                    path: data.path, // ID for apps, file path for files
                    type: data.type, // 'app' or 'file'
                    icon: data.icon, // fa-class string
                    color: data.color,
                    x: x - 40, // Center on mouse
                    y: y - 45
                });
                desktopManager.save();
                desktopManager.render();
            },

            removeShortcut: (id) => {
                desktopManager.shortcuts = desktopManager.shortcuts.filter(s => s.id !== id);
                desktopManager.save();
                desktopManager.render();
            },

            render: () => {
                const area = document.getElementById('shortcut-area');
                area.innerHTML = '';
                desktopManager.shortcuts.forEach(s => {
                    const el = document.createElement('div');
                    el.className = 'shortcut';
                    el.style.left = `${s.x}px`;
                    el.style.top = `${s.y}px`;
                    el.innerHTML = `<i class="fa-solid ${s.icon} s-icon" style="color:${s.color}"></i><div class="s-name">${s.name}</div>`;

                    // Drag existing shortcut
                    el.onmousedown = (e) => dragManager.start(e, 'move-shortcut', s.id);

                    // Double click to open
                    el.ondblclick = () => {
                        if (s.type === 'app') appManager.open(s.path); // path is app ID (e.g., 'code')
                        else openFileInOS(s.path);
                    };

                    // Right click context menu
                    el.oncontextmenu = (e) => {
                        e.preventDefault();
                        const menu = document.getElementById('context-menu');
                        menu.style.display = 'block';
                        menu.style.left = e.clientX + 'px';
                        menu.style.top = e.clientY + 'px';
                        menu.innerHTML = `<div class="ctx-item" onclick="desktopManager.removeShortcut('${s.id}')">Delete Shortcut</div>`;
                    };

                    area.appendChild(el);
                });
            }
        };
        // Call init at the bottom of your script

        const dragManager = {
            mode: null,
            data: null,
            ghost: document.getElementById('drag-ghost'),
            offset: { x: 0, y: 0 },
            isDragging: false,

            init: () => {
                document.addEventListener('mousemove', dragManager.move);
                document.addEventListener('mouseup', dragManager.end);
            },

            // Call this onmousedown of files in explorer or apps in dock
            start: (e, mode, data) => {
                // mode: 'new-item' (from dock/explorer) or 'move-shortcut' (existing)
                e.preventDefault();
                dragManager.mode = mode;
                dragManager.data = data;
                dragManager.isDragging = true;

                if (mode === 'new-item') {
                    dragManager.ghost.style.display = 'flex';
                    document.getElementById('ghost-name').innerText = data.name;
                } else if (mode === 'move-shortcut') {
                    // Calculate offset so it doesn't snap to top-left corner
                    const el = e.target.closest('.shortcut');
                    const rect = el.getBoundingClientRect();
                    dragManager.offset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                }
            },

            move: (e) => {
                if (!dragManager.mode) return;

                if (dragManager.mode === 'new-item') {
                    dragManager.ghost.style.left = (e.clientX + 10) + 'px';
                    dragManager.ghost.style.top = (e.clientY + 10) + 'px';
                } else if (dragManager.mode === 'move-shortcut') {
                    // Update visual position of existing shortcut immediately
                    const s = desktopManager.shortcuts.find(x => x.id === dragManager.data);
                    if (s) {
                        // We re-render specifically or just update DOM for performance
                        // For simplicity, let's update DOM directly here
                        // Note: You need to select the element again or store ref
                        // But simplified:
                        s.x = e.clientX - dragManager.offset.x;
                        s.y = e.clientY - dragManager.offset.y;
                        desktopManager.render(); // Brute force render for safety
                    }
                }
            },

            // Inside dragManager.end(e):
            end: (e) => {
                if (!dragManager.isDragging) return;
                dragManager.isDragging = false;
                dragManager.ghost.style.display = 'none';

                const dropTarget = document.elementFromPoint(e.clientX, e.clientY);
                const isTrash = dropTarget && dropTarget.closest('#trash-bin');

                if (dragManager.mode === 'new-item') {
                    // Drop on desktop to create shortcut
                    if (!isTrash && dropTarget && (dropTarget.id === 'desktop' || dropTarget.id === 'shortcut-area')) {
                        desktopManager.addShortcut(dragManager.data, e.clientX - 40, e.clientY - 45);
                    }
                }
                else if (dragManager.mode === 'move-shortcut') {
                    if (isTrash) {
                        // DELETE shortcut
                        desktopManager.shortcuts = desktopManager.shortcuts.filter(s => s.id !== dragManager.data);
                        desktopManager.render();
                        desktopManager.save();
                        notifications.show("Shortcut Removed", "success");
                    } else {
                        // MOVE shortcut
                        const item = desktopManager.shortcuts.find(s => s.id === dragManager.data);
                        if (item) {
                            item.x = e.clientX - dragManager.offset.x;
                            item.y = e.clientY - dragManager.offset.y;
                            desktopManager.render();
                            desktopManager.save();
                        }
                    }
                }

                // Cleanup visual effect
                document.getElementById('trash-bin').classList.remove('drag-over');
                dragManager.mode = null;
                dragManager.data = null;
            }
        };
        dragManager.init();

        /* --- DEVTOYS LOGIC --- */
        const devToys = {
            switchTab(tool) {
                // Hide all
                document.querySelectorAll('.tool-view').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tool-btn').forEach(el => el.classList.remove('active'));

                // Show selected
                document.getElementById(`tool-${tool}`).classList.add('active');
                // This is a bit of a hack to highlight the button based on index,
                // in production you'd use IDs for buttons too.
                const btns = document.querySelectorAll('.tool-btn');
                if (tool === 'json') btns[0].classList.add('active');
                if (tool === 'base64') btns[1].classList.add('active');
                if (tool === 'lorem') btns[2].classList.add('active');
            },

            formatJSON() {
                try {
                    const input = document.getElementById('dt-json-input').value;
                    const obj = JSON.parse(input);
                    document.getElementById('dt-json-output').value = JSON.stringify(obj, null, 4);
                } catch (e) {
                    document.getElementById('dt-json-output').value = "Invalid JSON Error";
                }
            },

            minifyJSON() {
                try {
                    const input = document.getElementById('dt-json-input').value;
                    const obj = JSON.parse(input);
                    document.getElementById('dt-json-output').value = JSON.stringify(obj);
                } catch (e) {
                    document.getElementById('dt-json-output').value = "Invalid JSON Error";
                }
            },

            b64Encode() {
                const input = document.getElementById('dt-b64-input').value;
                document.getElementById('dt-b64-output').value = btoa(input);
            },

            b64Decode() {
                try {
                    const input = document.getElementById('dt-b64-input').value;
                    document.getElementById('dt-b64-output').value = atob(input);
                } catch (e) {
                    document.getElementById('dt-b64-output').value = "Invalid Base64";
                }
            },

            genLorem(paras) {
                const text = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.";
                let res = "";
                for (let i = 0; i < paras; i++) res += text + "\n\n";
                document.getElementById('dt-lorem-output').value = res;
            }
        };

        // Initialize Settings on Boot
        // Add this line inside your existing window.onload function:
        // systemConfig.init();

        // --- WINDOW MANAGER ---
        // --- REPLACE EXISTING WindowManager CLASS IN index.html ---

        class WindowManager {
            constructor() {
                this.zIndex = 100;
                this.dragItem = null;
                this.offset = { x: 0, y: 0 };
                this.isDragging = false;

                document.addEventListener('mousemove', (e) => this.drag(e));
                document.addEventListener('mouseup', () => this.stopDrag());
            }

            focus(id) {
                const win = document.getElementById(id);
                if (win) win.style.zIndex = ++this.zIndex;
            }

            startDrag(e, id) {
                if (document.getElementById(id).classList.contains('maximized')) return;

                this.dragItem = document.getElementById(id);
                this.focus(id);
                this.isDragging = true;

                // Calculate offset
                const rect = this.dragItem.getBoundingClientRect();
                this.offset.x = e.clientX - rect.left;
                this.offset.y = e.clientY - rect.top;
            }

            drag(e) {
                if (!this.dragItem || !this.isDragging) return;

                // Normal movement
                let newX = e.clientX - this.offset.x;
                let newY = e.clientY - this.offset.y;

                this.dragItem.style.left = newX + 'px';
                this.dragItem.style.top = newY + 'px';

                // --- CROSS DISPLAY LOGIC ---
                const edgeThreshold = 10; // pixels from edge
                let direction = null;

                if (e.clientX >= window.innerWidth - edgeThreshold) direction = 'right';
                else if (e.clientX <= edgeThreshold) direction = 'left';

                // If hitting edge, trigger teleport
                if (direction) {
                    const appId = this.dragItem.id.replace('win-', '');
                    this.stopDrag(); // Stop dragging on this screen

                    // Gather State (Add more apps here as needed)
                    let state = {};
                    if (appId === 'code') state.content = document.getElementById('code-area').value;
                    if (appId === 'terminal') state.html = document.getElementById('term-body').innerHTML;
                    if (appId === 'browser') state.url = document.getElementById('browser-url').value;

                    // Send to Main
                    ipcRenderer.send('app-cross-display', { appId, state, direction });
                }
            }

            stopDrag() {
                this.dragItem = null;
                this.isDragging = false;
            }
        }

        // --- ADD THIS HELPER FUNCTION IN index.html ---

        function setupCrossDisplayListeners() {
            // 1. Success: The app moved to another screen, so hide it here
            ipcRenderer.on('app-teleported-success', (event, appId) => {
                appManager.close(appId);
            });

            // 2. Incoming: We are receiving an app from another screen
            ipcRenderer.on('incoming-app', (event, data) => {
                const { appId, state, edge } = data;

                // Open the app
                appManager.open(appId);
                const win = document.getElementById(`win-${appId}`);

                // Restore State
                if (appId === 'code' && state.content) document.getElementById('code-area').value = state.content;
                if (appId === 'terminal' && state.html) document.getElementById('term-body').innerHTML = state.html;
                if (appId === 'browser' && state.url) {
                    document.getElementById('browser-url').value = state.url;
                    document.getElementById('browser-frame').src = state.url;
                }

                // Position it at the correct entry point
                const width = win.offsetWidth;

                if (edge === 'right') {
                    // Coming from the right (so we place it on left)
                    win.style.left = '10px';
                } else if (edge === 'left') {
                    // Coming from the left (so we place it on right)
                    win.style.left = (window.innerWidth - width - 10) + 'px';
                }

                // Keep same Y height roughly
                win.style.top = '100px';

                windowManager.focus(`win-${appId}`);
            });
        }

        const windowManager = new WindowManager();

        // Listen for download completion from Main Process
        ipcRenderer.on('download-complete', (event, { fileName, filePath }) => {
            notifications.show(`Download Complete: ${fileName}`, 'success');

            // If we are currently looking at the Downloads folder, refresh to show the new file
            if (explorerApp.currentPath.includes('Downloads')) {
                explorerApp.refresh();
            }
        });

        // --- APP MANAGER ---
        const appManager = {
            open: (app) => {
                const win = document.getElementById(`win-${app}`);
                if (win) {
                    win.classList.remove('hidden');
                    windowManager.focus(`win-${app}`);
                    document.getElementById(`dock-${app}`).classList.add('active');

                    // In index.html script
                    const codeArea = document.querySelector('.code-area');

                    // Load saved draft on startup
                    const savedDraft = localStorage.getItem('editor-draft');
                    if (savedDraft && codeArea) codeArea.value = savedDraft;

                    // Save every time you type
                    codeArea.addEventListener('input', () => {
                        localStorage.setItem('editor-draft', codeArea.value);
                    });

                    // Specific app init
                    if (app === 'code') fileSystem.refreshUI();
                    if (app === 'code') fileSystem.openInEditor(fileSystem.currentFile);
                    if (app === 'settings') {
                        audioManager.init(); // Load devices only when opening settings
                    }
                } else {
                    notifications.show('App not installed in this demo.', 'warning');
                }
            },
            close: (app) => {
                document.getElementById(`win-${app}`).classList.add('hidden');
                document.getElementById(`dock-${app}`).classList.remove('active');
            },
            maximize: (app) => {
                document.getElementById(`win-${app}`).classList.toggle('maximized');
            },
            minimize: (app) => {
                // Animation to dock could go here
                document.getElementById(`win-${app}`).classList.add('hidden');
            }
        };

        // --- NOTIFICATIONS ---
        const notifications = {
            show: (msg, type = 'info') => {
                const area = document.getElementById('toast-area');
                const toast = document.createElement('div');
                toast.className = 'toast';
                let icon = '<i class="fa-solid fa-info-circle"></i>';
                if (type === 'success') icon = '<i class="fa-solid fa-check-circle" style="color:var(--success)"></i>';
                if (type === 'warning') icon = '<i class="fa-solid fa-exclamation-triangle" style="color:var(--warning)"></i>';

                toast.innerHTML = `${icon} <span>${msg}</span>`;
                area.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        };

        // --- GLOBAL CLOCK INIT ---
        // Run this immediately on all windows (Main and Secondary)
        function updateClock() {
            const clock = document.getElementById('clock');
            if (!clock) return;
            const options = systemConfig?.state?.showSeconds
                ? { hour: '2-digit', minute: '2-digit', second: '2-digit' }
                : { hour: '2-digit', minute: '2-digit' };
            clock.innerText = new Date().toLocaleTimeString([], options);
        }

        // --- GLOBAL CLOCK INIT ---
        // Run this immediately on all windows (Main and Secondary)
        setInterval(updateClock, 1000);

        const terminalApp = {
            history: [],
            historyIndex: -1,

            init() {
                const termInput = document.getElementById('term-input');
                if (!termInput) return;

                this.updatePrompt();

                termInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const cmd = termInput.value.trim();
                        this.execute(cmd);
                        this.history.push(cmd);
                        this.historyIndex = -1;
                        termInput.value = '';
                    }
                    // Command History (Up Arrow)
                    else if (e.key === 'ArrowUp') {
                        if (this.history.length > 0) {
                            if (this.historyIndex < this.history.length - 1) {
                                this.historyIndex++;
                                termInput.value = this.history[this.history.length - 1 - this.historyIndex];
                            }
                        }
                    }
                    // Command History (Down Arrow)
                    else if (e.key === 'ArrowDown') {
                        if (this.historyIndex > 0) {
                            this.historyIndex--;
                            termInput.value = this.history[this.history.length - 1 - this.historyIndex];
                        } else {
                            this.historyIndex = -1;
                            termInput.value = '';
                        }
                    }
                });
            },

            updatePrompt() {
                const prompt = document.querySelector('.term-prompt');
                if (prompt) {
                    const cleanName = systemConfig.state.username.toLowerCase().replace(/\s/g, '_');
                    prompt.innerText = `${cleanName}@CORE:~$`;
                }
            },

            execute(cmd) {
                const container = document.getElementById('term-body');
                const inputLine = document.getElementById('term-input').parentElement;
                const cleanName = systemConfig.state.username.toLowerCase().replace(/\s/g, '_');

                // Print Command
                const line = document.createElement('div');
                line.className = 'term-output';
                line.innerHTML = `<span class="term-prompt">${cleanName}@CORE:~$</span> ${cmd}`;
                container.insertBefore(line, inputLine);

                const output = document.createElement('div');
                output.className = 'term-output';

                const args = cmd.split(' ');
                const command = args[0].toLowerCase();

                switch (command) {
                    case 'help':
                        output.innerHTML = `
                            <div style="color:var(--accent)">CORE TERMINAL [Version 1.2]</div>
                            <div style="margin: 5px 0;">Available Commands:</div>
                            <div style="display:grid; grid-template-columns: 100px 1fr; gap: 5px;">
                                <span>cls / clear</span> <span>Clear screen</span>
                                <span>dir / ls</span>   <span>List files</span>
                                <span>ver</span>        <span>System version</span>
                                <span>whoami</span>     <span>Show current user</span>
                                <span>echo [msg]</span> <span>Display text</span>
                                <span>exit</span>       <span>Close terminal</span>
                                <span>color [hex]</span><span>Change accent color</span>
                            </div>`;
                        break;
                    case 'whoami':
                        output.innerText = `${systemConfig.state.username} (Administrator)`;
                        break;
                    case 'ver':
                        output.innerText = "Core OS Professional [Build 22H2.10.0.1]";
                        break;
                    case 'cls':
                    case 'clear':
                        const lines = container.querySelectorAll('.term-output');
                        lines.forEach(l => l.remove());
                        return;
                    case 'dir':
                    case 'ls':
                        output.innerText = fileSystem.listFiles().join('    ');
                        output.style.color = '#82aaff';
                        break;
                    case 'echo':
                        output.innerText = args.slice(1).join(' ');
                        break;
                    case 'color':
                        if (args[1]) {
                            systemConfig.state.accent = args[1];
                            systemConfig.apply();
                            output.innerText = "Accent color updated.";
                        } else {
                            output.innerText = "Usage: color [hex_code]";
                        }
                        break;
                    case 'exit':
                        appManager.close('terminal');
                        return;
                    default:
                        if (cmd !== "") {
                            output.innerText = `'${command}' is not recognized as an internal or external command.`;
                            output.style.color = 'var(--danger)';
                        }
                }

                if (output.innerHTML !== "") container.insertBefore(output, inputLine);
                container.scrollTop = container.scrollHeight;
            }
        };

        // Start Terminal Logic
        terminalApp.init();


        /* --- UPGRADE 2: THEME MANAGER --- */
        const themeManager = {
            applyTheme: (themeName) => {
                const root = document.documentElement;
                const desktop = document.getElementById('desktop');
                const loginScreen = document.getElementById('login-screen');
                const setLoginBackground = (url) => {
                    if (desktop) desktop.style.backgroundImage = `url('${url}')`;
                    if (loginScreen && url) loginScreen.style.backgroundImage = `url('${url}')`;
                };

                if (themeName === 'spiderpunk') {
                    root.style.setProperty('--accent', '#ff3d8b');
                    root.style.setProperty('--bg-os', '#0d0b12');
                    root.style.setProperty('--bg-window', '#1a0f1f');
                    // Using a cool, actual Spider-verse style image
                    const spiderpunkWallpaper = 'https://wallpaperbat.com/img/63152633-spider-punk-wallpaper.jpg';
                    document.getElementById('desktop').style.backgroundImage = `url('${spiderpunkWallpaper}')`;
                    setLoginBackground(spiderpunkWallpaper);
                }
                else if (themeName === 'matrix') {
                    root.style.setProperty('--accent', '#00ff41');
                    root.style.setProperty('--bg-os', '#000000');
                    root.style.setProperty('--bg-window', '#0d0d0d');
                    root.style.setProperty('--font-ui', "'Courier New', monospace");
                    document.body.style.fontFamily = "'Courier New', monospace";
                    // Set Matrix Wallpaper (Static fallback if canvas fails)
                    document.getElementById('desktop').style.backgroundImage = 'none';
                    document.getElementById('desktop').style.backgroundColor = 'black';
                    if (loginScreen) loginScreen.style.backgroundImage = 'none';
                } else if (themeName === 'synth') {
                    root.style.setProperty('--accent', '#ff00ff');
                    root.style.setProperty('--bg-os', '#12001f');
                    root.style.setProperty('--bg-window', '#1f002e');
                    root.style.setProperty('--font-ui', "'Inter', sans-serif");
                    const synthWallpaper = 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070';
                    document.getElementById('desktop').style.backgroundImage = `url('${synthWallpaper}')`;
                    setLoginBackground(synthWallpaper);
                } else if (themeName === 'nord') {
                    root.style.setProperty('--accent', '#88c0d0');
                    root.style.setProperty('--bg-os', '#2e3440');
                    root.style.setProperty('--bg-window', '#3b4252');
                    root.style.setProperty('--font-ui', "'Inter', sans-serif");
                    const nordWallpaper = 'https://images.unsplash.com/photo-1483058712412-4245e9b90334?q=80&w=2070';
                    document.getElementById('desktop').style.backgroundImage = `url('${nordWallpaper}')`;
                    setLoginBackground(nordWallpaper);
                } else {
                    // Default
                    root.style.setProperty('--accent', '#6366f1');
                    root.style.setProperty('--bg-os', '#050505');
                    root.style.setProperty('--bg-window', '#09090b');
                    root.style.setProperty('--font-ui', "'Inter', sans-serif");
                    const defaultWallpaper = 'https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=2574';
                    document.getElementById('desktop').style.backgroundImage = `url('${defaultWallpaper}')`;
                    setLoginBackground(defaultWallpaper);
                }
            },
            setTheme: (themeName) => {
                themeManager.applyTheme(themeName);
                // Save to system config so it persists
                if (typeof systemConfig !== 'undefined') {
                    systemConfig.state.themeName = themeName;
                    systemConfig.save();
                }
            }
        };

        /* --- UPGRADE 3: MATRIX SCREENSAVER --- */
        const screensaver = {
            active: false,
            timer: null,
            canvas: document.getElementById('screensaver'),
            ctx: document.getElementById('screensaver').getContext('2d'),
            chars: "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*",
            drops: [],

            init: () => {
                screensaver.resize();
                window.addEventListener('resize', screensaver.resize);

                // Listen for activity on the window AND any iframes
                const activityEvents = ['mousemove', 'mousedown', 'keypress', 'touchmove'];

                activityEvents.forEach(evt => {
                    document.addEventListener(evt, screensaver.resetTimer);
                });

                screensaver.resetTimer();

                // Check every second if the user is hovering over an iframe (iframe hack)
                setInterval(() => {
                    if (document.activeElement && document.activeElement.tagName === 'IFRAME') {
                        screensaver.resetTimer();
                    }
                }, 1000);

                // Loop
                setInterval(screensaver.draw, 33);
            },

            resize: () => {
                screensaver.canvas.width = window.innerWidth;
                screensaver.canvas.height = window.innerHeight;
                const columns = screensaver.canvas.width / 15; // Font size 15
                screensaver.drops = Array(Math.floor(columns)).fill(1);
            },

            resetTimer: () => {
                // If screensaver is already active, hide it
                if (screensaver.active) {
                    screensaver.canvas.style.display = 'none';
                    screensaver.active = false;
                }

                clearTimeout(screensaver.timer);

                // 1. If Browser is maximized, DO NOT activate screensaver (Movie mode)
                const browserWin = document.getElementById('win-browser');
                if (browserWin && browserWin.classList.contains('maximized') && !browserWin.classList.contains('hidden')) {
                    return;
                }

                // 2. Set idle time (increased to 5 minutes for dev work)
                screensaver.timer = setTimeout(screensaver.start, 300000); // 300,000ms = 5 mins
            },

            start: () => {
                screensaver.active = true;
                screensaver.canvas.style.display = 'block';
            },

            draw: () => {
                if (!screensaver.active) return;

                const ctx = screensaver.ctx;
                // Translucent black to create trail effect
                ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
                ctx.fillRect(0, 0, screensaver.canvas.width, screensaver.canvas.height);

                ctx.fillStyle = "#0F0"; // Green text
                ctx.font = "15px monospace";

                for (let i = 0; i < screensaver.drops.length; i++) {
                    const text = screensaver.chars[Math.floor(Math.random() * screensaver.chars.length)];
                    ctx.fillText(text, i * 15, screensaver.drops[i] * 15);

                    if (screensaver.drops[i] * 15 > screensaver.canvas.height && Math.random() > 0.975) {
                        screensaver.drops[i] = 0;
                    }
                    screensaver.drops[i]++;
                }
            }
        };

        // Start screensaver logic
        screensaver.init();

        // --- BOOT PROCESS ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('boot-layer').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                systemConfig.init();
                swipeUnlock.init();
            }, 2000);
        };

        function openBios() {
            document.getElementById('bios-screen').classList.remove('hidden');
        }

        function exitBios() {
            document.getElementById('bios-screen').classList.add('hidden');
        }

        window.addEventListener('keydown', (event) => {
            if (event.key === 'F6') {
                event.preventDefault();
                openBios();
            }
        });

        function checkLogin(e) {
            if (e.key === 'Enter') {
                attemptUnlock({ viaSwipe: false });
            }
        }

        ipcRenderer.on("unlock-session", () => {
            unlockDesktop()
        })

        function unlockDesktop() {
            resetLoginScreen();
            document.getElementById("login-screen").classList.add("hidden")
            document.getElementById("desktop").classList.remove("hidden")
            document.getElementById("desktop").classList.add("fade-in")
        }

        function resetLoginScreen() {
            const loginScreen = document.getElementById('login-screen');
            const loginCard = document.querySelector('.login-card');
            if (loginScreen) {
                loginScreen.classList.remove('swiping', 'swipe-armed');
                loginScreen.style.transform = '';
                loginScreen.style.opacity = '';
            }
            if (loginCard) {
                loginCard.style.transform = '';
            }
            const input = document.getElementById('password-input');
            if (input) input.value = '';
        }

        function attemptUnlock({ viaSwipe }) {
            const input = document.getElementById('password-input');
            const entered = input ? input.value.trim() : '';
            const passwordEnabled = systemConfig?.state?.passwordEnabled;

            if (viaSwipe && passwordEnabled) {
                notifications.show('Password required. Enter it to unlock.', 'warning');
                resetLoginScreen();
                return;
            }

            if (passwordEnabled) {
                if (!systemConfig.state.passwordValue || entered !== systemConfig.state.passwordValue) {
                    notifications.show('Incorrect password.', 'danger');
                    if (input) input.value = '';
                    return;
                }
            } else if (entered.toLowerCase() === 'spiderpunk') {
                themeManager.setTheme('spiderpunk');
                notifications.show('Spiderpunk mode unlocked.', 'success');
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('desktop').classList.remove('hidden');
            document.getElementById('desktop').classList.add('fade-in');
            ipcRenderer.send("login-success");

            updateClock();

            resetLoginScreen();
            notifications.show('Welcome back, Developer.', 'success');
        }

        const swipeUnlock = {
            active: false,
            startY: 0,
            currentY: 0,
            threshold: 180,
            init: () => {
                const loginScreen = document.getElementById('login-screen');
                if (!loginScreen) return;

                loginScreen.addEventListener('mousedown', (event) => {
                    if (!systemConfig?.state?.swipeToUnlock) return;
                    if (event.button !== 0) return;
                    if (event.target.closest('input') || event.target.closest('button')) return;
                    swipeUnlock.active = true;
                    swipeUnlock.startY = event.clientY;
                    swipeUnlock.currentY = event.clientY;
                    loginScreen.classList.add('swiping', 'swipe-armed');
                });

                document.addEventListener('mousemove', (event) => {
                    if (!swipeUnlock.active) return;
                    swipeUnlock.currentY = event.clientY;
                    const delta = Math.min(0, swipeUnlock.currentY - swipeUnlock.startY);
                    const loginCard = document.querySelector('.login-card');
                    loginScreen.style.transform = `translateY(${delta}px)`;
                    loginScreen.style.opacity = `${1 + delta / 300}`;
                    if (loginCard) {
                        loginCard.style.transform = `translateY(${delta * 0.6}px)`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (!swipeUnlock.active) return;
                    swipeUnlock.active = false;
                    const delta = swipeUnlock.currentY - swipeUnlock.startY;
                    const shouldUnlock = Math.abs(delta) > swipeUnlock.threshold && delta < 0;
                    if (shouldUnlock) {
                        attemptUnlock({ viaSwipe: true });
                    } else {
                        resetLoginScreen();
                    }
                });
            }
        };

        /* --- NEW FEATURES LOGIC --- */

        // 1. AI Logic
        function handleAIChat(e) {
            if (e.key === 'Enter') sendAIMessage();
        }

        function sendAIMessage() {
            const input = document.getElementById('chat-input');
            const history = document.getElementById('chat-history');
            const msg = input.value.trim();
            if (!msg) return;

            // Add User Message
            history.innerHTML += `<div class="msg user">${msg}</div>`;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            // Simulate Thinking Delay
            const typing = document.createElement('div');
            typing.className = 'msg ai';
            typing.innerHTML = '<i class="fa-solid fa-ellipsis fa-fade"></i>';
            history.appendChild(typing);
            history.scrollTop = history.scrollHeight;

            setTimeout(() => {
                typing.remove();
                let response = "I'm not connected to the cloud, but I think that's a great idea.";

                // Simple heuristic responses
                const lower = msg.toLowerCase();
                if (lower.includes('hello') || lower.includes('hi')) response = "Greetings, developer. Ready to code?";
                if (lower.includes('help')) response = "I can help you navigate Core OS. Try opening the Terminal or VS Code.";
                if (lower.includes('linux')) response = "Linux is the kernel at the heart of open source. Core OS pays homage to it.";
                if (lower.includes('js') || lower.includes('javascript')) response = "JavaScript is the engine of the web. You can run JS in the Terminal using the 'node' command.";
                if (lower.includes('date')) response = "The current system time is " + new Date().toLocaleTimeString();

                history.innerHTML += `<div class="msg ai">${response}</div>`;
                history.scrollTop = history.scrollHeight;
            }, 1000); // 1 second delay
        }

        // 2. Browser Logic
        function navigateBrowser(e) {
            if (e.key === 'Enter') {
                let url = document.getElementById('browser-url').value;
                if (!url.startsWith('http')) url = 'https://' + url;
                document.getElementById('browser-frame').src = url;
            }
        }

        // 3. Settings Logic
        function changeAccent(color) {
            document.documentElement.style.setProperty('--accent', color);
            document.documentElement.style.setProperty('--accent-hover', color);
            // Update login avatar background just in case
            document.querySelector('.avatar').style.background = color;
        }

        const wallpapers = [
            'https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=2574&auto=format&fit=crop', // Original
            'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop', // Space
            'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop', // Cyberpunk
            'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop', // Abstract
            'spiderpunk.jpg' // Spiderpunk
        ];
        let wpIndex = 0;

        function cycleWallpaper() {
            wpIndex = (wpIndex + 1) % wallpapers.length;
            document.getElementById('desktop').style.backgroundImage = `url('${wallpapers[wpIndex]}')`;
        }

        function handleRightClick(e) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            if (defaultContextMenuHtml) {
                menu.innerHTML = defaultContextMenuHtml;
            }
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
        }

        function hideContextMenu(event) {
            document.getElementById('context-menu').style.display = 'none';
            if (!pendingShortcut || !event) return;
            const isBackground = event.target.id === 'desktop' || event.target.id === 'shortcut-area';
            if (isBackground) {
                desktopManager.addShortcut(pendingShortcut, event.clientX, event.clientY);
                notifications.show(`${pendingShortcut.name} shortcut added`, 'success');
                pendingShortcut = null;
            }
        }

        function toggleStartMenu() {
            document.getElementById('start-menu').classList.toggle('open');
        }

        /* --- NEW APPS LOGIC --- */

        // 1. REQUEST APP LOGIC
        const requestApp = {
            send: async () => {
                const method = document.getElementById('req-method').value;
                const url = document.getElementById('req-url').value;
                const bodyStr = document.getElementById('req-json-body').value;
                const statusLabel = document.getElementById('req-status');
                const output = document.getElementById('req-response');

                statusLabel.innerText = "Sending...";
                output.value = "Loading...";

                try {
                    const options = { method };
                    if (method !== 'GET') {
                        options.headers = { 'Content-Type': 'application/json' };
                        options.body = bodyStr;
                    }

                    const res = await fetch(url, options);
                    statusLabel.innerText = `${res.status} ${res.statusText}`;

                    if (res.status >= 200 && res.status < 300) statusLabel.style.color = "var(--success)";
                    else statusLabel.style.color = "var(--danger)";

                    const data = await res.json();
                    output.value = JSON.stringify(data, null, 2);
                } catch (err) {
                    statusLabel.innerText = "Error";
                    statusLabel.style.color = "var(--danger)";
                    output.value = err.message + "\n\n(Note: CORS might block some external sites in this demo environment.)";
                }
            }
        };

        // 2. SQL STUDIO LOGIC (MOCK ENGINE)
        const sqlApp = {
            // Mock Database
            db: {
                users: [
                    { id: 1, name: "Alice", role: "Admin", active: true },
                    { id: 2, name: "Bob", role: "Dev", active: true },
                    { id: 3, name: "Charlie", role: "User", active: false },
                    { id: 4, name: "David", role: "Dev", active: true }
                ],
                logs: [
                    { id: 101, event: "Login", time: "10:00 AM" },
                    { id: 102, event: "Error", time: "10:05 AM" },
                    { id: 103, event: "Logout", time: "11:00 AM" }
                ],
                products: [
                    { id: 1, name: "Keyboard", price: 120 },
                    { id: 2, name: "Mouse", price: 50 },
                    { id: 3, name: "Monitor", price: 300 }
                ]
            },

            insertTemplate: (table) => {
                document.getElementById('sql-input').value = `SELECT * FROM ${table}`;
                sqlApp.run();
            },

            run: () => {
                const query = document.getElementById('sql-input').value.trim();
                const output = document.getElementById('sql-output');

                // Very Basic Parser
                const match = query.match(/SELECT \* FROM (\w+)/i);

                if (match && match[1]) {
                    const tableName = match[1];
                    const data = sqlApp.db[tableName];

                    if (data) {
                        sqlApp.renderTable(data, output);
                    } else {
                        output.innerHTML = `<div style="padding:20px; color:#ef4444;">Error: Table '${tableName}' not found.</div>`;
                    }
                } else {
                    output.innerHTML = `<div style="padding:20px; color:#ef4444;">Error: Syntax not supported in this demo. Try: SELECT * FROM [table]</div>`;
                }
            },

            renderTable: (data, container) => {
                if (!data || data.length === 0) {
                    container.innerHTML = '<div style="padding:20px;">No results.</div>';
                    return;
                }
                const keys = Object.keys(data[0]);
                let html = '<table class="sql-grid"><thead><tr>';
                keys.forEach(k => html += `<th>${k.toUpperCase()}</th>`);
                html += '</tr></thead><tbody>';

                data.forEach(row => {
                    html += '<tr>';
                    keys.forEach(k => html += `<td>${row[k]}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            }
        };

        // 3. MARKDOWN APP LOGIC (SIMPLE PARSER)
        const mdApp = {
            render: () => {
                const input = document.getElementById('md-input').value;
                const output = document.getElementById('md-output');

                // Simple Regex Replacement for Demo (No external libs)
                let html = input
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')            // h1
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')           // h2
                    .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')          // bold
                    .replace(/\*(.*)\*/gim, '<i>$1</i>')              // italic
                    .replace(/`(.*?)`/gim, '<code>$1</code>')         // inline code
                    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>') // quote
                    .replace(/^- (.*$)/gim, '<li>$1</li>')            // list
                    .replace(/\n/gim, '<br>');                        // line breaks

                output.innerHTML = html;
            },
            init: () => {
                mdApp.render(); // Render initial text
            }
        };

        // Initialize Markdown on load
        setTimeout(mdApp.init, 1000);

        const wifiManager = {
            networks: [
                { ssid: "backofhouse", strength: "Strong", password: "Love0612" },
                { ssid: "MommaBear..", strength: "Medium", password: "love0612" },
                { ssid: "HiddenNetwork", strength: "Strong", password: "hidden402wowlolyoudontpass" }
            ],
            connectedSsid: null,
            connectingSsid: null,

            render: () => {
                const list = document.getElementById('wifi-list');
                if (!list) return;
                list.innerHTML = '';

                wifiManager.networks.forEach(network => {
                    const item = document.createElement('div');
                    item.className = 'wifi-network';

                    const meta = document.createElement('div');
                    meta.className = 'wifi-meta';

                    const ssid = document.createElement('div');
                    ssid.className = 'wifi-ssid';
                    ssid.textContent = network.ssid;

                    const status = document.createElement('div');
                    status.className = 'wifi-status';
                    status.textContent = wifiManager.connectingSsid === network.ssid
                        ? 'Connecting...'
                        : wifiManager.connectedSsid === network.ssid
                            ? 'Connected'
                            : `Signal: ${network.strength}`;

                    meta.appendChild(ssid);
                    meta.appendChild(status);

                    const action = document.createElement('span');
                    action.textContent = wifiManager.connectingSsid === network.ssid
                        ? 'Connecting...'
                        : wifiManager.connectedSsid === network.ssid
                            ? ''
                            : 'Connect';

                    item.appendChild(meta);
                    item.appendChild(action);

                    item.onclick = () => wifiManager.connect(network.ssid);

                    list.appendChild(item);
                });
            },

            connect: async (ssid) => {
                if (wifiManager.connectingSsid) return;
                const network = wifiManager.networks.find(item => item.ssid === ssid);
                if (!network) return;
                const entered = prompt(`Enter password for ${ssid}`);
                if (entered === null) return;
                if (entered !== network.password) {
                    notifications.show('Incorrect Wi-Fi password', 'danger');
                    return;
                }

                wifiManager.connectingSsid = ssid;
                wifiManager.render();
                notifications.show(`Connecting to ${ssid}...`, 'warning');

                await new Promise(resolve => setTimeout(resolve, 900));

                wifiManager.connectedSsid = ssid;
                wifiManager.connectingSsid = null;
                notifications.show(`Connected to ${ssid}`, 'success');
                wifiManager.updateIcon();
                wifiManager.render();
            },

            refresh: () => {
                notifications.show('Wi-Fi scan completed', 'success');
                wifiManager.render();
            },

            updateIcon: () => {
                const icon = document.getElementById('wifi-icon');
                if (!icon) return;
                icon.className = wifiManager.connectedSsid ? 'fa-solid fa-wifi' : 'fa-solid fa-wifi-slash';
            }
        };

        function toggleWifiMenu(event) {
            event.stopPropagation();
            closeStatusMenus('wifi-menu');
            document.getElementById('wifi-menu').classList.toggle('show');
            wifiManager.render();
            wifiManager.updateIcon();
        }

        function toggleBatteryMenu(event) {
            event.stopPropagation();
            closeStatusMenus('battery-menu');
            document.getElementById('battery-menu').classList.toggle('show');
        }

        function closeStatusMenus(exceptId) {
            const menus = ['wifi-menu', 'battery-menu'];
            menus.forEach(id => {
                if (id !== exceptId) {
                    document.getElementById(id)?.classList.remove('show');
                }
            });
        }

        /* --- TOP BAR FIXES --- */
        // This was missing before!
        function toggleMenu(menuId) {
            // 1. Close any currently open menus
            const dropdowns = document.getElementsByClassName("dropdown-content");
            for (let i = 0; i < dropdowns.length; i++) {
                if (dropdowns[i].id !== menuId) {
                    dropdowns[i].classList.remove('show');
                }
            }

            // 2. Toggle the requested one
            document.getElementById(menuId).classList.toggle("show");
        }

        // Close menus when clicking anywhere else on the desktop
        window.onclick = function (event) {
            if (!event.target.matches('.menu-item')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) {
                        dropdowns[i].classList.remove('show');
                    }
                }
            }
            if (!event.target.closest('.status-item')) {
                closeStatusMenus();
            }
        }

        /* --- AUDIO MANAGER --- */
        const audioManager = {
            init: async () => {
                // Request permission to see devices (requires user interaction usually, or secure context)
                // In Electron, this usually works automatically.
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioOutput = devices.filter(device => device.kind === 'audiooutput');

                const select = document.getElementById('audio-output-select');
                select.innerHTML = '';

                audioOutput.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Speaker ${select.length + 1}`;
                    select.appendChild(option);
                });
            },

            setDevice: async (deviceId) => {
                // This sets the output for the Browser App specifically
                // Note: setSinkId is a specialized web API feature
                const browser = document.getElementById('browser-view');

                try {
                    // We try to set it on the main window audio (for system sounds)
                    const audioElements = document.querySelectorAll('audio, video');
                    for (const element of audioElements) {
                        if (element.setSinkId) {
                            await element.setSinkId(deviceId);
                        }
                    }

                    // For the webview, we have to inject JS to tell IT to switch devices
                    if (browser) {
                        // This is advanced, but we try to force the webview to use the device
                        // by executing setSinkId on its internal media elements
                        browser.executeJavaScript(`
                                    navigator.mediaDevices.enumerateDevices().then(devs => {
                                        const audio = document.querySelectorAll('audio, video');
                                        audio.forEach(a => a.setSinkId('${deviceId}').catch(e => console.log(e)));
                                    });
                                 `);
                    }

                    notifications.show("Audio Output Switched", "success");
                } catch (err) {
                    console.error('Error setting audio device:', err);
                    notifications.show("Could not switch device", "danger");
                }
            },

            setVolume: (val) => {
                // Create a 'gain' effect or just control media elements
                const volume = val / 100;
                const media = document.querySelectorAll('audio, video');
                media.forEach(m => m.volume = volume);

                // Also try to set webview volume
                const browser = document.getElementById('browser-view');
                if (browser) {
                    browser.setAudioMuted(val == 0);
                    // Webview doesn't have a direct setVolume, so we inject JS
                    browser.executeJavaScript(`
                                document.querySelectorAll('audio, video').forEach(el => el.volume = ${volume});
                            `);
                }
            }
        };

        // Initialize audio list when settings is opened
        // You can add this trigger to your appManager.open('settings') function logic

    </script>
</body>
</html>
